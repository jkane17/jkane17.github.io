<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Q/KDB Blog</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/custom-highlight-00a73c7c.css">
        <link rel="stylesheet" href="theme/navigation-ccf6f99d.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-3381e94a.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-9dbffcb5.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Q/KDB Blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="qkdb-blog"><a class="header" href="#qkdb-blog">Q/KDB+ Blog</a></h1>
<p>Welcome to the Q/KDB+ Blog. Here you’ll find articles exploring various aspects of the Q programming language and KDB+ database.</p>
<h2 id="latest-articles"><a class="header" href="#latest-articles">Latest Articles</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Title</th><th>Published</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><strong><a href="#command-line-arguments-in-qkdb">Command Line Arguments in Q/KDB+</a></strong></td><td>Sep 20, 2024</td><td>Discover how to customize Q session behavior using command line arguments.</td></tr>
<tr><td><strong><a href="#an-introduction-to-interacting-with-rest-apis-in-qkdb">An Introduction to Interacting with REST APIs in Q/KDB+</a></strong></td><td>Sep 11, 2024</td><td>Learn how to interact with REST APIs using Q, including HTTP GET requests, HTTPS, and handling responses.</td></tr>
<tr><td><strong><a href="#the-little-q-keywords-that-could">The Little Q Keywords That Could</a></strong></td><td>Aug 15, 2024</td><td>Explore lesser-known and underutilised Q keywords that can be powerful when used effectively.</td></tr>
<tr><td><strong><a href="#analysis-of-q-memory-allocation">Analysis of Q Memory Allocation</a></strong></td><td>Aug 15, 2024</td><td>Delve into how Q handles memory allocation using the buddy memory allocation system.</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="command-line-arguments-in-qkdb"><a class="header" href="#command-line-arguments-in-qkdb">Command Line Arguments in Q/KDB+</a></h1>
<p><img src="images/command_line_args.png" title="Cover Image" alt="Cover Image"></p>
<p>In Q/KDB+, command line arguments allow users to customise the behaviour of a session when it is started. By passing specific arguments, you can configure memory usage, port bindings, and even pre-load scripts, among other settings. This can be especially useful in automated environments or when dealing with large data sets that require specific resources.</p>
<p>Typically, a Q session is started by simply typing <code>q</code> in the command line or terminal:</p>
<pre><code class="language-powershell">C:\&gt; q
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)
</code></pre>
<p>However, Q also supports additional arguments that can be passed after the <code>q</code> invocation to modify its behaviour. The general syntax looks like this:</p>
<pre><code class="language-powershell">q [file] [-option [params] … ]
</code></pre>
<h2 id="loading-files-and-directories"><a class="header" href="#loading-files-and-directories">Loading Files and Directories</a></h2>
<p>One of the simplest ways to initialise a Q session is by loading files or directories at start-up. The first argument you provide after invoking q is a file or directory that Q will automatically load upon launch. This is especially useful for preloading variables or scripts when starting a Q session.</p>
<p>For example, let’s consider a file called <code>test.q</code> with the following content:</p>
<pre><code class="language-q">a:10
</code></pre>
<p>To load this file when starting Q, simply pass it as the first argument:</p>
<pre><code class="language-q">C:\&gt; q test.q
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)a
10
</code></pre>
<p>As you can see, the variable <code>a</code> from <code>test.q</code> is now available in the session.</p>
<h3 id="loading-multiple-files-from-a-directory"><a class="header" href="#loading-multiple-files-from-a-directory">Loading Multiple Files from a Directory</a></h3>
<p>Q also allows you to load multiple scripts from a directory by passing the directory name as the argument. In this case, all Q scripts in the directory will be executed in alphabetical order.</p>
<p>For example, consider a directory called <code>test</code> with the following files:</p>
<pre><code class="language-q">// test1.q
a:10
</code></pre>
<pre><code class="language-q">// test2.q
b:20
</code></pre>
<p>By passing the directory <code>test</code> to the Q command, both files are loaded:</p>
<pre><code class="language-q">C:\&gt; q test\
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)a
10
q)b
20
</code></pre>
<p>Here, both variables <code>a</code> and <code>b</code> are accessible because <code>test1.q</code> and <code>test2.q</code> were loaded sequentially.</p>
<h3 id="handling-non-q-files"><a class="header" href="#handling-non-q-files">Handling Non-Q Files</a></h3>
<p>If the directory contains non-Q compatible files (files without <code>.q</code>, <code>.k</code>, or <code>.s</code> extensions), Q will raise an error and halt the loading process:</p>
<pre><code class="language-q">C:\&gt; ls test\

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        13/09/2024     12:09              4 test1.q
-a----        13/09/2024     12:09              4 test2.q
-a----        13/09/2024     12:14             17 test3.txt


C:\&gt; q test\
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

'./test3.txt
  [0]  (.Q.lo)

 .Q )
</code></pre>
<p>To avoid such errors, ensure that all files in the directory have valid extensions like <code>.q</code>, <code>.k</code>, or <code>.s</code>.</p>
<h4 id="file-extensions-explained"><a class="header" href="#file-extensions-explained">File Extensions Explained</a></h4>
<ul>
<li>
<p><code>.q</code> – Extension used for Q scripts. Files with the <code>.q</code> extension contain Q code that can be executed or loaded directly into the session.</p>
</li>
<li>
<p><code>.k</code> – Extension associated with K scripts, the predecessor of Q. Files ending in <code>.k</code> can still be executed within Q, ensuring backward compatibility with older K code.</p>
</li>
<li>
<p><code>.s</code> – Extension for SQL code (not to be confused with the more common use of <code>.s</code> for assembly source code files). For more information on using SQL in Q, see <a href="https://code.kx.com/insights/1.11/core/sql.html#running-sql">here</a>.</p>
</li>
</ul>
<h3 id="use-case-loading-databases"><a class="header" href="#use-case-loading-databases">Use Case: Loading Databases</a></h3>
<p>One practical and common use case for command-line arguments in Q is loading splayed or partitioned databases directly into a session. By passing the root directory of the database as an argument when launching Q, the system will automatically memory-map the data, making its contents available for immediate querying without needing to fully load it into memory.</p>
<p>This approach is particularly useful when working with large datasets, as memory-mapping allows Q to efficiently handle data on disk while still providing high-speed access. Here’s an example:</p>
<pre><code class="language-powershell">C:\&gt; ls db/t

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----        16/09/2024     09:55             12 .d
-a----        16/09/2024     09:55             40 a
-a----        16/09/2024     09:55             40 b
</code></pre>
<pre><code class="language-q">C:\&gt; q db/
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)t
a b
---
1 4
2 5
3 6
</code></pre>
<p>In the above example, a splayed database located at the <code>db/</code> directory is loaded. The database contains a table <code>t</code>, which is instantly available in the Q session. This makes it possible to interact with large tables or partitions of data without the overhead of fully loading them into memory, which is crucial when working with vast amounts of time-series data or transactional records.</p>
<p>By leveraging memory-mapping, Q ensures that only the necessary parts of the data are accessed, optimising performance while maintaining minimal memory usage. This functionality makes Q an efficient choice for handling large-scale databases, especially in financial and real-time data environments where speed and resource management are critical.</p>
<p>This example demonstrates how easy it is to load a splayed or partitioned database with a simple command-line argument, highlighting Q’s ability to streamline database management and access.</p>
<h2 id="built-in-options"><a class="header" href="#built-in-options">Built-in Options</a></h2>
<p>Q provides several <a href="https://code.kx.com/q/basics/cmdline/">built-in command line options</a> that allow you to control various aspects of a Q session. These options follow the format:</p>
<pre><code>-? [param/s]
</code></pre>
<p>where <code>?</code> is replaced by a single lowercase or uppercase letter, and <code>[param/s]</code> represents optional parameters that configure the behaviour of the option.</p>
<h3 id="example-1-set-a-listening-port-with--p"><a class="header" href="#example-1-set-a-listening-port-with--p">Example 1: Set a Listening Port with <code>-p</code></a></h3>
<p>The <code>-p</code> option allows you to set a listening port for your Q process, which is essential when running Q as a server to handle client queries. For instance, to set the port to 5000, you would use:</p>
<pre><code class="language-q">C:\&gt; q -p 5000
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\p // Verify the port setting
5000i
</code></pre>
<p>To let Q choose any available ephemeral port, pass <code>0W</code> as the argument:</p>
<pre><code class="language-q">C:\&gt; q -p 0W
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\p // Check which port was automatically assigned
61411i
</code></pre>
<p>Alternatively, setting <code>-p 0</code> means Q will not listen on any port (which is also the default behaviour):</p>
<pre><code class="language-q">C:\&gt; q -p 0
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\p
0i
</code></pre>
<h3 id="example-2-set-a-workspace-memory-limit-with--w"><a class="header" href="#example-2-set-a-workspace-memory-limit-with--w">Example 2: Set a Workspace Memory Limit with <code>-w</code></a></h3>
<p>Since Q is an in-memory database, it’s important to manage memory usage carefully, especially in long-running processes. The <code>-w</code> option allows you to set a memory limit, preventing the Q process from consuming excessive system resources.</p>
<p>To set a memory limit of 1 GB, pass <code>1024</code> (since the value is in megabytes) as an argument to <code>-w</code>:</p>
<pre><code class="language-q">C:\&gt; q -w 1024
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q).Q.w[]`wmax // Check memory limit (in bytes)
1073741824
</code></pre>
<p>If the process attempts to use more memory than the specified limit, it will terminate with a <code>-w abort</code> error. For example:</p>
<pre><code class="language-q">q)til 100000000 // Create a large list of longs
'-w abort
C:\&gt;
</code></pre>
<p>The default memory limit is 0, meaning no limit is enforced:</p>
<pre><code class="language-q">C:\&gt; q
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q).Q.w[]`wmax
0
</code></pre>
<h3 id="example-3-set-a-query-timeout-with--t"><a class="header" href="#example-3-set-a-query-timeout-with--t">Example 3: Set a Query Timeout with <code>-T</code></a></h3>
<p>In server setups, Q processes can execute queries from external clients. Ill-formed or long-running queries can monopolise resources, so the <code>-T</code> option is used to set a timeout for client queries. Any query exceeding this time limit will be aborted automatically.</p>
<p>To set a timeout of 5 seconds, along with a listening port on 5000, you would use:</p>
<pre><code class="language-q">C:\&gt; q -T 5 -p 5000
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\T // Verify the timeout setting
5i
</code></pre>
<p>Now, let’s set up another Q process to act as a client and query the server:</p>
<pre><code class="language-q">C:\&gt; q
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)h:hopen 5000
q)h"(0&lt;){1+x}/1" // Infinite loop query
'stop
  [0]  h"(0&lt;){1+x}/1"
</code></pre>
<p>The server automatically killed the query after 5 seconds and returned a <code>'stop</code> error to the client.</p>
<blockquote>
<p><strong>Note:</strong> The timeout only applies to client queries. If you execute an infinite loop directly on the server itself, it will not be interrupted.</p>
</blockquote>
<p>The default timeout is 0, which means no timeout is enforced:</p>
<pre><code class="language-q">C:\&gt; q
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\T
0i
</code></pre>
<h3 id="example-4-changing-values-after-start-up"><a class="header" href="#example-4-changing-values-after-start-up">Example 4: Changing Values After Start-Up</a></h3>
<p>The built-in command-line options provided during the start of a Q session are set automatically and persist throughout the session. However, the values of most options can be modified dynamically after the session starts using <em>system commands</em>, without restarting Q. This feature adds flexibility when working in Q environments, particularly when it’s necessary to adjust settings based on runtime conditions.</p>
<p>For example, you can adjust the listening port (<code>-p</code>) during a session:</p>
<pre><code class="language-q">C:\&gt; q -p 5000
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\p // Initially set to 5000
5000i 
q)\p 8000
q)\p // Now changed to 8000
8000i 
q).z.X // Raw command line unchanged
,"q"
"-p"
"5000"
</code></pre>
<p>In the above example, the port was initially set to 5000 using the command line, and then dynamically changed to 8000 within the Q session. Importantly, the raw command line (<code>.z.X</code>) remains unchanged, preserving the initial values passed during start-up (see <a href="#example-3-custom-and-built-in-options-together">below</a> for more on <code>.z.X</code>).</p>
<p>You can achieve the same result using the <code>system</code> keyword to invoke system commands:</p>
<pre><code class="language-q">C:\&gt; q -p 5000
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)system"p" // Check current port
5000i
q)system"p 8000"
q)system"p" // Port changed to 8000
8000i
</code></pre>
<p>This approach provides more flexibility by allowing you to modify system settings dynamically, based on the needs of your application or environment. Whether you need to change the port number or other built-in options, using system commands within Q gives you control and adaptability during runtime.</p>
<h2 id="custom-options"><a class="header" href="#custom-options">Custom Options</a></h2>
<p>Q also provides the flexibility to define your own custom command line options, which follow a similar syntax to the built-in options:</p>
<pre><code class="language-powershell">-myOpt [param/s]
</code></pre>
<h3 id="reserved-single-letter-option-names"><a class="header" href="#reserved-single-letter-option-names">Reserved Single-Letter Option Names</a></h3>
<p>It is important to note that Q reserves single-letter names exclusively for its built-in options. Even if a specific single-letter option is not currently in use, attempting to assign it as a custom option will result in an error. This ensures that future Q updates do not conflict with user-defined options.</p>
<pre><code class="language-powershell">C:\&gt; q -a 1 2 3
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

'a invalid
</code></pre>
<p>In this case, the single-letter option <code>-a</code> is reserved, and Q throws an error when trying to use it. To avoid such issues, always use multi-letter names for custom options to ensure compatibility.</p>
<h3 id="example-1-a-single-custom-option"><a class="header" href="#example-1-a-single-custom-option">Example 1: A Single Custom Option</a></h3>
<p>In this example, we pass a custom option <code>-myOpt</code> with a value of <code>10</code>:</p>
<pre><code class="language-q">C:\&gt; q -myOpt 10
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)
</code></pre>
<p>You can inspect the custom command line option using the <code>.z.x</code> system variable, which captures the custom options passed during start-up:</p>
<pre><code class="language-q">q).z.x
"-myOpt"
"10"
</code></pre>
<p>Here, <code>.z.x</code> shows that the custom option <code>-myOpt</code> and its value 10 were correctly passed to the Q session.</p>
<h3 id="example-2-multiple-custom-options"><a class="header" href="#example-2-multiple-custom-options">Example 2: Multiple Custom Options</a></h3>
<p>You can also pass multiple custom options. In this example, we use two custom options, <code>-myOpt1</code> and <code>-myOpt2</code>, with values of <code>10</code> and <code>hello world</code>, respectively:</p>
<pre><code class="language-q">C:\&gt; q -myOpt1 10 -myOpt2 hello world
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q).z.x
"-myOpt1"
"10"
"-myOpt2"
"hello"
"world"
</code></pre>
<p>Notice that <code>.z.x</code> splits <code>hello world</code> into two separate arguments. On the command line, spaces are treated as argument separators. If you intended to pass <code>hello world</code> as a single argument, you need to wrap the argument in quotes:</p>
<pre><code class="language-q">C:\&gt; q -myOpt1 10 -myOpt2 'hello world'
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q).z.x
"-myOpt1"
"10"
"-myOpt2"
"hello world"
</code></pre>
<p>Now <code>.z.x</code> correctly captures <code>hello world</code> as a single argument.</p>
<h3 id="example-3-custom-and-built-in-options-together"><a class="header" href="#example-3-custom-and-built-in-options-together">Example 3: Custom and Built-in Options Together</a></h3>
<p>You can mix custom options with Q’s built-in options. In this example, we pass a custom option <code>-myOpt</code> and the built-in <code>-p</code> option to set a listening port:</p>
<pre><code class="language-q">C:\&gt; q -myOpt 10 -p 5000
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q).z.x
"-myOpt"
"10"
</code></pre>
<p>Here, <code>.z.x</code> only displays the custom option <code>-myOpt</code>. This is because <code>.z.x</code> is designed to capture only the custom command line options, not the built-in ones.</p>
<p>To view the entire command line, including built-in options, you can use <code>.z.X</code> (uppercase X), which provides the raw command line used to start the Q session:</p>
<pre><code class="language-q">q).z.X
"C:\\q\\w64\\q.exe"
"-myOpt"
"10"
"-p"
"5000"
</code></pre>
<p>The first item in this list is the path to the Q executable, followed by all the options passed in the command line, including both custom and built-in options, in the order they were provided.</p>
<h2 id="parsing-the-command-line"><a class="header" href="#parsing-the-command-line">Parsing the Command Line</a></h2>
<p><code>.z.x</code> and <code>.z.X</code> provide a way to view the options and arguments supplied at the command line. However, extracting the values manually from these strings can be cumbersome.</p>
<p>Fortunately, Q offers a more convenient way to parse the command line options.</p>
<h3 id="converting-to-a-dictionary-with-qopt"><a class="header" href="#converting-to-a-dictionary-with-qopt">Converting to a Dictionary with <code>.Q.opt</code></a></h3>
<p>In the following example, we pass a script file <code>test.q</code>, two custom options <code>-myOpt1</code> and <code>-myOpt2</code> with values <code>10</code> and <code>'Hello World'</code>, and the built-in <code>-p</code> option with a value of <code>5000</code>:</p>
<pre><code class="language-q">C:\&gt; q test.q -myOpt1 10 -p 5000 -myOpt2 'Hello World'
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q).z.x
"-myOpt1"
"10"
"-myOpt2"
"Hello World"
q).Q.opt .z.x
myOpt1| "10"
myOpt2| "Hello World"
</code></pre>
<p>Applying <code>.Q.opt</code> to <code>.z.x</code> converts the options into a dictionary, mapping the option names (as symbols) to their respective values (as strings).</p>
<p><code>.Q.opt</code> also works with <code>.z.X</code>, even when the first two items are the Q binary and a script file:</p>
<pre><code class="language-q">q).z.X
"C:\\q\\w64\\q.exe"
"test.q"
"-myOpt1"
"10"
"-p"
"5000"
"-myOpt2"
"Hello World"
q).Q.opt .z.X
myOpt1| "10"
p     | "5000"
myOpt2| "Hello World"
</code></pre>
<h3 id="casting-and-providing-defaults-with-qdef"><a class="header" href="#casting-and-providing-defaults-with-qdef">Casting and Providing Defaults with <code>.Q.def</code></a></h3>
<p><code>.Q.def</code> allows you to provide default values for command line options. It also casts the option values to the same type as the default.</p>
<p><code>.Q.def</code> takes two arguments:</p>
<ul>
<li>A dictionary mapping option names to their default values.</li>
<li>A dictionary mapping provided option names to their values (i.e., <code>.Q.opt .z.X</code>).</li>
</ul>
<h4 id="example-1-casting"><a class="header" href="#example-1-casting">Example 1: Casting</a></h4>
<pre><code class="language-q">q)show defaults:`myOpt1`myOpt2`p!(100f;`Nothing;1234)
myOpt1| 100f
myOpt2| `Nothing
p     | 1234
q).Q.def[defaults;.Q.opt .z.X]
myOpt1| 10f
myOpt2| `Hello World
p     | 5000
</code></pre>
<p>In this example, the value for <code>myOpt1</code> is cast to a float (<code>10f</code>) because the default value is a float. The value for <code>myOpt2</code> is cast to a symbol (<code> `Hello World</code>) since the default is a symbol.</p>
<h4 id="example-2-defaulting"><a class="header" href="#example-2-defaulting">Example 2: Defaulting</a></h4>
<p>In this example, we provide values for <code>myOpt2</code> and <code>p</code>, but omit <code>myOpt1</code>. The missing option uses the default:</p>
<pre><code class="language-q">C:\&gt; q test.q -p 5000 -myOpt2 'Hello World'
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)show defaults:`myOpt1`myOpt2`p!(100f;`Nothing;1234)
myOpt1| 100f
myOpt2| `Nothing
p     | 1234
q).Q.def[defaults;.Q.opt .z.X]
myOpt1| 100f
myOpt2| `Hello World
p     | 5000
</code></pre>
<p>Since <code>myOpt1</code> was not provided on the command line, <code>.Q.def</code> uses the default value <code>100f</code>.</p>
<h4 id="example-3-list-of-arguments"><a class="header" href="#example-3-list-of-arguments">Example 3: List of Arguments</a></h4>
<p><code>myOpt2</code> is cast to a symbol because its default value was a symbol (<code> `Nothing</code>). However, it would be better if it were a string since the user’s input might include spaces.</p>
<pre><code class="language-q">q)show defaults:`myOpt1`myOpt2`p!(100f;"Nothing";1234)
myOpt1| 100f
myOpt2| "Nothing"
p     | 1234
q)show args:.Q.def[defaults;.Q.opt .z.X]
myOpt1| 100f
myOpt2| ," "
p     | 5000
</code></pre>
<p>The value of <code>myOpt2</code> has been replaced with an enlisted null char.</p>
<p>When providing a default for a string type, we must ensure that the default value is enlisted so it is handled correctly by <code>.Q.def</code>:</p>
<pre><code class="language-q">q)show defaults:`myOpt1`myOpt2`p!(100f;enlist "Nothing";1234)
myOpt1| 100f
myOpt2| ,"Nothing"
p     | 1234
q).Q.def[defaults;.Q.opt .z.X]
myOpt1| 100f
myOpt2| ,"Hello World"
p     | 5000
</code></pre>
<p>This issue does not affect other list types, for example:</p>
<pre><code class="language-q">C:\&gt; q -longs 1 2 3 -syms abc xyz
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)show defaults:`longs`missingLongs`syms`missingSyms!(10 20 30;8 9;`123`789;`hey`ho)
longs       | 10 20 30
missingLongs| 8 9
syms        | `123`789
missingSyms | `hey`ho
q).Q.def[defaults;.Q.opt .z.X]
longs       | 1 2 3
missingLongs| 8 9
syms        | `abc`xyz
missingSyms | `hey`ho
</code></pre>
<p>However, if you want to default to a single value but expect a list from the user, you must ensure the default is enlisted:</p>
<pre><code class="language-q">C:\&gt; q -longs 1 2 3
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)show defaults:`longs`missingLongs!(100;10 20 30)
longs       | 100
missingLongs| 10 20 30
q).Q.def[defaults;.Q.opt .z.X]
longs       | 1
missingLongs| 10 20 30
</code></pre>
<p>The provided values <code>1 2 3</code> were truncated to just <code>1</code> because the default was not enlisted.</p>
<pre><code class="language-q">q)show defaults:`longs`missingLongs!(enlist 100;10 20 30)
longs       | ,100
missingLongs| 10 20 30
q).Q.def[defaults;.Q.opt .z.X]
longs       | 1  2  3
missingLongs| 10 20 30
</code></pre>
<h3 id="applying-defaults-to-built-in-options"><a class="header" href="#applying-defaults-to-built-in-options">Applying Defaults to Built-in Options</a></h3>
<p>In a previous example, we set <code>5000</code> as the default value for the <code>-p</code> option. If the value is not provided, we may specify a default, but it’s up to the user to actually apply these defaults:</p>
<pre><code class="language-q">C:\&gt; q
KDB+ 4.1 2024.03.12 Copyright (C) 1993-2024 Kx Systems
w64/ 8(24)core 32448MB ..

q)\p
0i
q)show defaults:enlist[`p]!enlist 5000
p| 5000
q).Q.def[defaults;.Q.opt .z.X]
p| 5000
q)\p
0i
q)"p ",string .Q.def[defaults;.Q.opt .z.X]`p
"p 5000"
q)system "p ",string .Q.def[defaults;.Q.opt .z.X]`p // Set the listening port
q)\p
5000i
</code></pre>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Parsing and handling command-line options in Q can significantly enhance the flexibility and configurability of your scripts. By using the built-in functions <code>.z.x</code>, <code>.z.X</code>, <code>.Q.opt</code>, and <code>.Q.def</code>, you can easily access, process, and apply default values to both custom and built-in options. These tools allow you to convert command-line arguments into structured data like dictionaries, cast values to appropriate types, and handle multiple arguments efficiently.</p>
<p>Understanding these features not only improves the maintainability of your Q code but also allows you to build scripts that can adapt to various input configurations seamlessly. Whether you are working with custom options or using default values for built-in commands, Q provides the mechanisms needed to simplify these processes, making it easier to develop dynamic and reusable Q scripts.</p>
<p>Incorporating these best practices into your development workflow will help ensure that your Q scripts remain robust, adaptable, and user-friendly.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="an-introduction-to-interacting-with-rest-apis-in-qkdb"><a class="header" href="#an-introduction-to-interacting-with-rest-apis-in-qkdb">An Introduction to Interacting with REST APIs in Q/KDB+</a></h1>
<p><img src="images/rest_apis_introduction.png" title="Cover Image" alt="Cover Image"></p>
<p>In today’s interconnected world, many websites and services provide programmatic access to their data through REST APIs. REST (Representational State Transfer) APIs allow different systems to securely exchange data over the internet. The Q programming language includes built-in HTTP request capabilities and, in this blog, we’ll explore how to interact with REST APIs using Q.</p>
<h2 id="http-get-via-qhg"><a class="header" href="#http-get-via-qhg">HTTP GET via <code>.Q.hg</code></a></h2>
<p>The <code>.Q.hg</code> function in Q is a powerful tool that allows you to perform HTTP GET requests directly from your Q session. By simply passing a URL to <code>.Q.hg</code>, you can retrieve raw data, such as the HTML of a webpage, which can then be processed or analysed.</p>
<pre><code class="language-q">q).Q.hg `:http://www.google.com
"&lt;!doctype html&gt;&lt;html itemscope=\"\" itemtype=\"http://schema.org/WebPage\" lang=\"en-GB\"&gt;&lt;head&gt;...
</code></pre>
<h2 id="https"><a class="header" href="#https">HTTPS</a></h2>
<p>HTTPS (Hypertext Transfer Protocol Secure) is an extension of HTTP that uses <a href="https://code.kx.com/q/kb/ssl/">SSL/TLS</a> protocols to encrypt data, ensuring secure communication between clients and servers. To make HTTPS requests in Q, your environment must be configured to support SSL/TLS. If this configuration is missing, Q will raise an error when attempting an HTTPS request.</p>
<pre><code class="language-q">q).Q.hg `:https://www.google.com
'conn. OS reports: The requested protocol has not been configured into the system, or no implementation for it exists.
  [0]  .Q.hg `:https://www.google.com
       ^
</code></pre>
<p>SSL verification can be bypassed by setting the <code>SSL_VERIFY_SERVER</code> environment variable to <code>NO</code>. This should only be used in trusted environments, as disabling SSL verification can expose your application to security risks.</p>
<h3 id="windows-command-prompt"><a class="header" href="#windows-command-prompt">Windows Command Prompt</a></h3>
<pre><code class="language-powershell">set "SSL_VERIFY_SERVER=NO" 
</code></pre>
<h3 id="linux--macos-terminal"><a class="header" href="#linux--macos-terminal">Linux &amp; macOS Terminal</a></h3>
<pre><code class="language-bash">export SSL_VERIFY_SERVER=NO
</code></pre>
<h3 id="example-in-q"><a class="header" href="#example-in-q">Example in Q</a></h3>
<p>Once the environment variable is set, you can verify it and perform an HTTPS request:</p>
<pre><code class="language-q">q)getenv `SSL_VERIFY_SERVER
"NO"

q).Q.hg `:https://www.google.com
"&lt;!doctype html&gt;&lt;html itemscope=\"\" itemtype=\"http://schema.org/WebPage\" lang=\"en-GB\"&gt;&lt;head&gt;...
</code></pre>
<h2 id="json"><a class="header" href="#json">JSON</a></h2>
<p>JSON (JavaScript Object Notation) is a lightweight data interchange format widely used in REST APIs due to its simplicity and ease of parsing. In Q, JSON objects and arrays map naturally to dictionaries and tables, respectively, making it straightforward to work with API data.</p>
<h3 id="json-objects"><a class="header" href="#json-objects">JSON Objects</a></h3>
<p>JSON objects are structured as a collection of key-value pairs, which directly correspond to Q dictionaries. Each key is a string, and its associated value can be a string, number, array, object, or Boolean.</p>
<pre><code class="language-JSON">{
    "firstName": "John", 
    "lastName": "Smith"
}
</code></pre>
<p>In this example, <code>firstName</code> and <code>lastName</code> are keys, and <code>"John"</code> and <code>"Smith"</code> are their respective values.</p>
<h3 id="json-arrays"><a class="header" href="#json-arrays">JSON Arrays</a></h3>
<p>JSON arrays are ordered collections of values, which can include objects, similar to a list of dictionaries, i.e., a table, in Q.</p>
<pre><code class="language-JSON">[
    { "firstName": "John", "lastName": "Wick" },
    { "firstName": "Mary", "lastName": "Sue" }
]
</code></pre>
<p>In this example, the array contains two JSON objects, each representing a person with <code>firstName</code> and <code>lastName</code> fields.</p>
<h3 id="working-with-json-in-q"><a class="header" href="#working-with-json-in-q">Working with JSON in Q</a></h3>
<p>Q simplifies the process of decoding JSON data using the <code>.j.k</code> function. This function parses a JSON string into a corresponding Q data structure—dictionaries for objects and tables for arrays of objects.</p>
<h4 id="example-1-parsing-a-json-object"><a class="header" href="#example-1-parsing-a-json-object">Example 1: Parsing a JSON Object</a></h4>
<pre><code class="language-q">q).j.k "{ \"firstName\": \"John\", \"lastName\": \"Smith\" }"
firstName| "John"
lastName | "Smith"
</code></pre>
<p>Here, the JSON object is parsed into a Q dictionary with <code>firstName</code> and <code>lastName</code> as keys.</p>
<h4 id="example-2-parsing-a-json-array"><a class="header" href="#example-2-parsing-a-json-array">Example 2: Parsing a JSON Array</a></h4>
<pre><code class="language-q">q).j.k "[ { \"firstName\": \"John\", \"lastName\": \"Wick\" }, { \"firstName\": \"Mary\", \"lastName\": \"Sue\" } ]"
firstName lastName
------------------
"John"    "Wick"
"Mary"    "Sue"
</code></pre>
<p>This JSON array is parsed into a Q table, with <code>firstName</code> and <code>lastName</code> as column names.</p>
<p>JSON is a common format for data exchange in APIs, and Q’s built-in capabilities make it easy to decode and manipulate this data efficiently.</p>
<h2 id="a-real-example-using-the-cheapshark-api"><a class="header" href="#a-real-example-using-the-cheapshark-api">A Real Example: Using the <em>CheapShark</em> API</a></h2>
<p><em>CheapShark</em> is a website that aggregates the best deals on PC games from various popular stores like <em>Steam</em>, <em>Humble Bundle</em>, <em>Fanatical</em>, and more. It offers a free, easy-to-use REST API that does not require an authorisation key, making it an excellent resource for learning how to work with real-world APIs.</p>
<h3 id="understanding-the-api"><a class="header" href="#understanding-the-api">Understanding the API</a></h3>
<p>Most sites that provide a REST API will offer documentation to guide users on how to interact with their endpoints. The documentation for the <em>CheapShark</em> API can be found <a href="https://apidocs.cheapshark.com/">here</a>.</p>
<h3 id="making-api-calls"><a class="header" href="#making-api-calls">Making API Calls</a></h3>
<p>API calls typically begin with a base URL, which serves as the root address that you extend with specific endpoints to access different resources.</p>
<pre><code class="language-q">q)baseURL:`:https://www.cheapshark.com/api/1.0
</code></pre>
<p>In this example, <code>1.0</code> denotes the API version. API versions can change over time as the service evolves, so it’s essential to check the documentation for the correct version.</p>
<p>To request specific data, the base URL is extended with an endpoint. According to the <em>CheapShark</em> documentation, one available endpoint is <em>deals</em>, which provides information on current game deals.</p>
<h4 id="querying-the-deals-endpoint"><a class="header" href="#querying-the-deals-endpoint">Querying the Deals Endpoint</a></h4>
<p>The base URL can be extended with the <em>deals</em> endpoint to retrieve information about ongoing sales:</p>
<pre><code class="language-q">q).Q.dd[baseURL;`deals]
`:https://www.cheapshark.com/api/1.0/deals
</code></pre>
<p>The above code constructs the full URL to the deals endpoint. To fetch data from this endpoint, use the <code>.Q.hg</code> function to send an HTTP GET request and then parse the JSON response with <code>.j.k</code>:</p>
<pre><code class="language-q">q)deals:.j.k .Q.hg .Q.dd[baseURL;`deals]
</code></pre>
<p>This command retrieves and decodes the JSON response into a Q table. You can then inspect the data:</p>
<pre><code class="language-q">q)type deals
98h
q)count deals
60
q)first deals
internalName      | "METAMORPHOSIS"
title             | "Metamorphosis"
metacriticLink    | "/game/metamorphosis/"
dealID            | "oML4oLCz0hlxkKKQpDwVSBwm6NNQUvEBx1igr7uOgWw%3D"
storeID           | ,"1"
gameID            | "218750"
salePrice         | "10.50"
normalPrice       | "34.98"
isOnSale          | ,"1"
savings           | "69.982847"
metacriticScore   | ,"0"
steamRatingText   | "Very Positive"
steamRatingPercent| "83"
steamRatingCount  | "405"
steamAppID        | "1025410"
releaseDate       | 1.724976e+09
lastChange        | 1.724246e+09
dealRating        | "10.0"
thumb             | "https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/1025410/c..
</code></pre>
<p>In the <code>deals</code> table, each row corresponds to a game deal, with fields like <code>title</code>, <code>salePrice</code>, and <code>normalPrice</code> providing details about the game and its discount.</p>
<p>This example demonstrates how to use Q to interact with a real REST API, retrieving and processing JSON data effectively.</p>
<h3 id="schema-mapping"><a class="header" href="#schema-mapping">Schema Mapping</a></h3>
<p>When working with external data, especially from APIs, the incoming data might not always match the desired format or types. In such cases, it’s essential to “clean” the data—formatting, casting types, and removing erroneous rows to ensure consistency and usability. A good approach is to define a schema that outlines the expected structure and data types, which can then be applied to the incoming data.</p>
<h4 id="defining-the-schema"><a class="header" href="#defining-the-schema">Defining the Schema</a></h4>
<p>One effective way to define and manage this schema is by using a CSV file. The schema can specify the column names, data types, whether the columns are required, and any additional attributes.</p>
<pre><code class="language-CSV">column,origColumn,ty,required,enabled,isKey,attrib,description
internalName,internalName,s,0,0,0,,Game title used internally by CheapShark
title,title,*,1,1,0,,Game title
metacriticLink,metacriticLink,*,0,0,0,,Link to game page on Metacritic 
dealID,dealID,*,1,1,1,u,Deal identifier
storeID,storeID,j,1,1,0,,Game store identifier
gameID,gameID,j,1,1,0,,Game identifier
salePrice,salePrice,f,1,1,0,,Deal/reduced price of game (USD)
normalPrice,normalPrice,f,1,1,0,,Usual/full price of game (USD)
isOnSale,isOnSale,b,0,1,0,,True if game is currently on sale
savings,savings,f,0,1,0,,Percent saved on sale price compared to normal price  
metacriticScore,metacriticScore,j,1,1,0,,Score on Metacritic (0-100)
steamRatingText,steamRatingText,*,1,1,0,,Rating on Steam
steamRatingPercent,steamRatingPercent,j,1,1,0,,Percentage rating on Steam (0-100)
steamRatingCount,steamRatingCount,j,1,1,0,,Number of ratings given on Steam
steamAppID,steamAppID,j,0,0,0,,Application identifier on Steam
releaseDate,releaseDate,j,1,1,0,,Date game was released
lastChange,lastChange,j,0,0,0,,Date of last change made to game
dealRating,dealRating,f,1,1,0,,CheapShark deal rating (0.0-10.0)
thumb,thumb,*,0,0,0,,Link to thumbnail image
</code></pre>
<h4 id="loading-the-schema"><a class="header" href="#loading-the-schema">Loading the Schema</a></h4>
<p>Q provides a straightforward way to load a CSV file into a table. For our schema configuration, we can use the following command to load the schema from a CSV file:</p>
<pre><code class="language-q">q)show schema:("sscbbbs*";enlist ",") 0: `:schema/deals.csv
column             origColumn         ty required enabled isKey attrib description               ..
-------------------------------------------------------------------------------------------------..
internalName       internalName       s  0        0       0            "Game title used internall..
title              title              *  1        1       0            "Game title"              ..
metacriticLink     metacriticLink     *  0        0       0            "Link to game page on Meta..
dealID             dealID             *  1        1       1     u      "Deal identifier"         ..
storeID            storeID            j  1        1       0            "Game store identifier"   ..
gameID             gameID             j  1        1       0            "Game identifier"         ..
..
</code></pre>
<p>This command reads the <code>schema/deals.csv</code> file and displays its contents as a table. Each row in the schema configuration corresponds to a column in the deals table.</p>
<ul>
<li><code>column</code>: The desired name for the column in Q.</li>
<li><code>origColumn</code>: The original column name from the external source.</li>
<li><code>ty</code>: The expected data type for the column.</li>
<li><code>required</code>: A flag indicating whether the column is mandatory.</li>
<li><code>enabled</code>: A flag indicating whether the column should be included in the final table.</li>
<li><code>isKey</code>: A flag to indicate if the column should be used as a key.</li>
<li><code>attrib</code>: Any attributes that should be applied to the column (e.g., <code>u</code> for unique).</li>
<li><code>description</code>: A brief explanation of what the column represents.</li>
</ul>
<p>This schema setup provides a clear structure for managing and validating the data we receive from the deals API.</p>
<h4 id="the-applyschema-function"><a class="header" href="#the-applyschema-function">The <code>applySchema</code> Function</a></h4>
<p>To ensure the <code>deals</code> table conforms to the expected schema, the following function is defined:</p>
<pre><code class="language-q">// Ensure a table conforms to the given schema
applySchema:{[schema;tab]
    // Select only enabled columns from the schema - useful for excluding unnecessary columns
    schema:select from schema where enabled;
    
    // Ensure all required columns are present in the data
    reqCols:exec origColumn from schema where required;
    if[not all b:reqCols in cols tab; 
        msg:"Required columns missing: ",", " sv string reqCols where not b;
        -1 msg;
        'msg
    ];
    
    // Keep only columns that are both expected and received
    tab:#[;tab] cols[tab] inter exec origColumn from schema;

    // Rename columns to conform to Q's naming conventions
    tab:xcol[;tab] exec origColumn!column from schema;
    
    // Cast columns to their correct data types
    tab:cast[cols tab;exec (column!ty) cols tab from schema;tab];
    
    // Apply attributes to the appropriate columns
    tab:applyAttr[;tab] exec column!attrib from schema where not null attrib;
    
    // Set the specified columns as the key(s) of the table
    tab:xkey[;tab] exec column from schema where isKey;

    // Return the cleaned and formatted table
    tab
 }
</code></pre>
<h5 id="explanation-of-the-applyschema-function"><a class="header" href="#explanation-of-the-applyschema-function">Explanation of the <code>applySchema</code> Function:</a></h5>
<ol>
<li>
<p><strong>Selecting Enabled Columns</strong>: The schema may include columns that are not needed for the current operation. This step filters out any columns that are not marked as enabled in the schema.</p>
</li>
<li>
<p><strong>Checking for Required Columns</strong>: Ensures that all columns marked as required in the schema are present in the incoming data. If any required columns are missing, the function throws an error with a descriptive message.</p>
</li>
<li>
<p><strong>Filtering Received Columns</strong>: The function retains only those columns in the incoming data that are both expected (as per the schema) and present in the received data. This helps to discard any extraneous columns.</p>
</li>
<li>
<p><strong>Renaming Columns</strong>: Column names are often inconsistent with Q’s conventions when received from external sources (not the case with <em>CheapShark</em> data). This step renames the columns to conform to Q’s naming conventions, which are specified in the schema.</p>
</li>
<li>
<p><strong>Casting Columns to Correct Data Types</strong>: The function casts each column to its appropriate data type as specified in the schema. This is important for ensuring that the data can be accurately and efficiently processed.</p>
</li>
<li>
<p><strong>Applying Attributes</strong>: Certain attributes, like <code>u</code> (unique), may need to be applied to specific columns. This step applies those attributes based on the schema configuration.</p>
</li>
<li>
<p><strong>Setting the Table Key</strong>: The function sets the key for the table using the columns marked as <code>isKey</code> in the schema. This is crucial for operations that depend on uniquely identifying rows in the table.</p>
</li>
<li>
<p><strong>Returning the Cleaned Table</strong>: Finally, the function returns the table with all the above transformations applied, ensuring it is in a clean, consistent, and usable format.</p>
</li>
</ol>
<h4 id="helper-functions-used-in-applyschema"><a class="header" href="#helper-functions-used-in-applyschema">Helper Functions Used in <code>applySchema</code></a></h4>
<h5 id="column-type-casting"><a class="header" href="#column-type-casting">Column Type Casting</a></h5>
<p>The <code>applySchema</code> function relies on the following helper function to cast columns to their correct data types:</p>
<pre><code class="language-q">// Cast column types in tab
cast:{[columns;ty;tab]
    col2Ty:columns!ty;
    col2Ty,:exec c!upper col2Ty c from meta tab where t="C";
    col2Ty:{($),x,y}'[col2Ty;key col2Ty];
    ![tab;();0b;col2Ty]
 }
</code></pre>
<p>Explanation:</p>
<ul>
<li>The <code>cast</code> function creates a mapping (<code>col2Ty</code>) between column names and their intended types.</li>
<li>For columns that are received as strings, the function checks their actual data type and applies the appropriate casting by converting the type character to its uppercase form.</li>
<li>The function then generates a list of applicable casting functions and applies these to the corresponding columns in the table. This ensures that each column in the table is correctly typed according to the schema.</li>
</ul>
<h5 id="applying-attributes-to-columns"><a class="header" href="#applying-attributes-to-columns">Applying Attributes to Columns</a></h5>
<p>Another important aspect of schema application is setting the correct attributes for columns. The following helper function is used for this purpose:</p>
<pre><code class="language-q">// Apply attributes to columns
applyAttr:{[col2Attr;tab] ![tab;();0b;] {(#;enlist x;y)}'[col2Attr;key col2Attr]}
</code></pre>
<p>Explanation:</p>
<ul>
<li>The <code>applyAttr</code> function creates a mapping (<code>col2Attr</code>) between column names and their associated attributes.</li>
<li>In the example provided, the mapping could look like <code>dealID | `u</code>, which means that the <code>u</code> (unique) attribute should be applied to the <code>dealID</code> column within the table.</li>
</ul>
<h4 id="applying-the-schema"><a class="header" href="#applying-the-schema">Applying the Schema</a></h4>
<p>Now that we’ve defined the <code>applySchema</code> function, let’s put it into action by applying the schema to the <code>deals</code> table. This will ensure that the table conforms to the expected structure, with the appropriate data types, column names, and attributes as defined in the schema.</p>
<pre><code class="language-q">q)deals:applySchema[schema;deals]
</code></pre>
<p>After applying the schema, we can inspect the first row of the <code>deals</code> table to verify that the data has been correctly formatted (note that <code>dealID</code> is a key column and is not shown when the <code>first</code> keyword is applied):</p>
<pre><code class="language-q">q)first deals
title             | "Metamorphosis"
storeID           | 1
gameID            | 218750
salePrice         | 10.5
normalPrice       | 34.98
isOnSale          | 1b
savings           | 69.98285
metacriticScore   | 0
steamRatingText   | "Very Positive"
steamRatingPercent| 83
steamRatingCount  | 406
releaseDate       | 1724976000
dealRating        | 10f
</code></pre>
<h4 id="converting-unix-epoch-timestamps-to-q-timestamps"><a class="header" href="#converting-unix-epoch-timestamps-to-q-timestamps">Converting Unix Epoch Timestamps to Q Timestamps</a></h4>
<p>In the <code>deals</code> table, the <code>releaseDate</code> column is currently a long integer. According to the <em>CheapShark</em> documentation, this column represents a Unix Epoch timestamp, which is the number of seconds elapsed since <code>1970.01.01</code>.</p>
<p>To make this data more usable, we need to convert these Unix Epoch timestamps into Q timestamps, which are based on the number of nanoseconds since <code>2000.01.01</code>.</p>
<p>Q provides a straightforward way to perform this conversion, as shown below:</p>
<pre><code class="language-q">q)"P"$string 1724976000
2024.08.30D00:00:00.000000000
</code></pre>
<p>The <code>"P"$</code> operation converts a string representation of the Unix Epoch timestamp into a Q timestamp.</p>
<p>This conversion isn’t handled within the <code>applySchema</code> function because the <code>releaseDate</code> column is received as a float. To correctly convert the Unix Epoch timestamp to a Q timestamp, the value must first be cast to a long, then converted from a string representation of that long integer.</p>
<p>We can automate this process with a helper function:</p>
<pre><code class="language-q">// Convert Unix Epoch timestamps to Q timestamps
convertEpoch:{[epochCols;tab]
    ![tab;();0b;] epochCols!("P"$string@),/:epochCols:(epochCols,()) inter cols tab
 }
</code></pre>
<p>This function:</p>
<ul>
<li>Takes as input the names of the columns (<code>epochCols</code>) that store Unix Epoch timestamps and the table (<code>tab</code>) containing these columns.</li>
<li>Converts the values in these columns from Unix Epoch timestamps to Q timestamps.</li>
</ul>
<p>Now, let’s apply this function to the <code>deals</code> table:</p>
<pre><code class="language-q">q)deals:convertEpoch[`releaseDate;deals]
q)first deals
title             | "Metamorphosis"
storeID           | 1
gameID            | 218750
salePrice         | 10.5
normalPrice       | 34.98
isOnSale          | 1b
savings           | 69.98285
metacriticScore   | 0
steamRatingText   | "Very Positive"
steamRatingPercent| 83
steamRatingCount  | 406
releaseDate       | 2024.08.30D00:00:00.000000000
dealRating        | 10f
</code></pre>
<h3 id="example-queries"><a class="header" href="#example-queries">Example Queries</a></h3>
<p>With the formatted <code>deals</code> table, you can now easily extract valuable insights. Below are some examples of useful queries you can perform:</p>
<h4 id="find-games-that-are-free"><a class="header" href="#find-games-that-are-free">Find Games That Are Free</a></h4>
<p>To identify which games are currently free, you can run the following query:</p>
<pre><code class="language-q">q)select from deals where salePrice=0
dealID                                                  | title                        storeID gameID salePrice normalPrice isOnSale savings ..
--------------------------------------------------------| -----------------------------------------------------------------------------------..
"hnqzhI6mSozJT13ntObN06QUeuLOaArkDyEu%2BiBplK4%3D"      | "Wild Card Football"         25      269270 0         29.99       1        100     ..
"l%2BZiBW2Mu0W4B%2BipW%2FpUJ%2BAn218BfeYzAKecxjhUGO0%3D"| "Fallout Classic Collection" 25      120604 0         19.99       1        100     ..
</code></pre>
<p>This query filters the <code>deals</code> table to return only the rows where the <code>salePrice</code> is 0, showing which games are currently available for free.</p>
<h4 id="sort-games-by-metacritic-rating"><a class="header" href="#sort-games-by-metacritic-rating">Sort Games by Metacritic Rating</a></h4>
<p>If you want to see the games sorted by their <em>Metacritic</em> score, with the highest-rated games first, use this query:</p>
<pre><code class="language-q">q)`metacriticScore xdesc deals
dealID                                                | title                                        storeID gameID salePrice normalPrice ..
------------------------------------------------------| ----------------------------------------------------------------------------------..
"OGCfBOUZvvl8JPIWeBbYeWvtFw%2BBEy9WgFdO7pM999Q%3D"    | "Deus Ex: Human Revolution - Director's Cut" 2       102249 2.55      19.99       ..
"h1pI0RMkHs6sjcjboS%2FvYhEytAI7XAat%2BSiXmP%2FL0OA%3D"| "Metro 2033 Redux"                           25      109746 1.99      19.99       ..
"Ersqftfht15yRvVi%2BQtYqzHcXHuORprGmyDT0uvo5zc%3D"    | "Homeworld Remastered Collection"            1       141243 3.49      34.99       ..
"3vW2Xy%2BiwEVnQOoN7KB2RlEAYz1%2FqK0IheNSCUA3g64%3D"  | "Shadow Tactics: Blades of the Shogun"       25      158443 3.99      39.99       ..
"chTGFNtThpFwF7mhwKUFmuh101BeXYsHrDyGbnwDLw0%3D"      | "Deus Ex: Mankind Divided"                   2       143165 3.83      29.99       ..
..
</code></pre>
<p>This query sorts the deals table by the <code>metacriticScore</code> in descending order, allowing you to quickly identify the top-rated games.</p>
<h4 id="identify-games-with-high-discounts"><a class="header" href="#identify-games-with-high-discounts">Identify Games with High Discounts</a></h4>
<p>To find games where you can save more than 90%, use the following query:</p>
<pre><code class="language-q">q)select from deals where savings&gt;90
dealID                                                    | title                                    storeID gameID salePrice normalPrice ..
----------------------------------------------------------| ------------------------------------------------------------------------------..
"hnqzhI6mSozJT13ntObN06QUeuLOaArkDyEu%2BiBplK4%3D"        | "Wild Card Football"                     25      269270 0         29.99       ..
"syEZpIi1rsbwUJ1YU1OKiLx1O3gN1Ax0ei1ANNvNsqI%3D"          | "NHRA: Speed for All - Ultimate Edition" 25      277998 7.99      79.99       ..
"ut1jqPlDrAYP%2BfA%2BWwDTf7DX%2B69aQWre5UlfuOLtLwE%3D"    | "Strange Brigade - Deluxe Edition"       2       186386 6         79.99       ..
"Kp3%2BW%2B6AtA%2FpJ5TzS9HpxUmOT0xZIWoiB%2BEgs%2F9JzpU%3D"| "Sniper Elite 4 Deluxe Edition"          2       158734 6.75      89.99       ..
"l%2BZiBW2Mu0W4B%2BipW%2FpUJ%2BAn218BfeYzAKecxjhUGO0%3D"  | "Fallout Classic Collection"             25      120604 0         19.99       ..
..
</code></pre>
<p>This query selects games where the savings column shows a discount greater than 90%, helping you to spot the best deals available.</p>
<h3 id="filtered-queries"><a class="header" href="#filtered-queries">Filtered Queries</a></h3>
<p>Instead of retrieving all deals from the API (which may be constrained by page size), you can apply filters directly in your API queries to target specific data.</p>
<h4 id="building-the-filter"><a class="header" href="#building-the-filter">Building the Filter</a></h4>
<p>First, we’ll create a dictionary that maps filter names to their respective values. In this example, we want to retrieve all deals from <code>storeID = 1</code> with a <code>salePrice</code> less than or equal to $10:</p>
<pre><code class="language-q">q)flts:`storeID`upperPrice!("1";"10")
</code></pre>
<h4 id="composing-the-filter-string"><a class="header" href="#composing-the-filter-string">Composing the Filter String</a></h4>
<p>Next, we’ll use a helper function to convert this dictionary into a filter string that can be appended to the API URL:</p>
<pre><code class="language-q">q)buildFltStr:"&amp;" sv value {[flts] {x,"=",y}'[string key flts;flts]}@
</code></pre>
<p>This function generates an <code>&amp;</code>-delimited string of <code>key=value</code> pairs from the dictionary:</p>
<pre><code class="language-q">q)buildFltStr flts
"storeID=1&amp;upperPrice=10"
</code></pre>
<h4 id="constructing-the-api-url"><a class="header" href="#constructing-the-api-url">Constructing the API URL</a></h4>
<p>We can now construct the full API URL with the filter string included:</p>
<pre><code class="language-q">q).Q.dd[baseURL;] `$"deals?",buildFltStr flts
`:https://www.cheapshark.com/api/1.0/deals?storeID=1&amp;upperPrice=10
</code></pre>
<h4 id="fetching-filtered-data"><a class="header" href="#fetching-filtered-data">Fetching Filtered Data</a></h4>
<p>Let’s call the API using the constructed URL to retrieve the filtered deals:</p>
<pre><code class="language-q">q)filteredDeals:.j.k .Q.hg .Q.dd[baseURL;] `$"deals?",buildFltStr flts
q)first filteredDeals
internalName  | "HOMEWORLDREMASTEREDCOLLECTION"
title         | "Homeworld Remastered Collection"
metacriticLink| "/game/homeworld-remastered-collection/"
dealID        | "Ersqftfht15yRvVi%2BQtYqzHcXHuORprGmyDT0uvo5zc%3D"
storeID       | ,"1"
gameID        | "141243"
salePrice     | "3.49"
..
</code></pre>
<p>Since this query still uses the deals API endpoint, the data structure returned follows the same schema as before.</p>
<h4 id="applying-the-schema-and-converting-timestamps"><a class="header" href="#applying-the-schema-and-converting-timestamps">Applying the Schema and Converting Timestamps</a></h4>
<p>Finally, we’ll apply the schema and convert any Unix Epoch timestamps in the retrieved data:</p>
<pre><code class="language-q">q)filteredDeals:applySchema[schema;filteredDeals]
q)filteredDeals:convertEpoch[`releaseDate;filteredDeals]
q)first filteredDeals
title      | "Homeworld Remastered Collection"
storeID    | 1
gameID     | 141243
salePrice  | 3.49
normalPrice| 34.99
isOnSale   | 1b
savings    | 90.02572
..
</code></pre>
<h2 id="response-header"><a class="header" href="#response-header">Response Header</a></h2>
<p>When making HTTP requests, responses include not only the requested content (like the deals we’ve seen) but also a header. Headers can contain valuable information, such as the status of the call (e.g., OK, Not Found) and other metadata.</p>
<h3 id="extracting-the-response-header"><a class="header" href="#extracting-the-response-header">Extracting the Response Header</a></h3>
<p>The utility function <code>.Q.hg</code> simplifies our lives by focusing on the content we need and hiding the header. However, there are cases where the header information is crucial. For example, the <em>CheapShark</em> API returns only up to 60 deals per page by default. To retrieve more data, you’ll need to know how many pages of deals exist, which is indicated by the <code>x-total-page-count</code> header element.</p>
<h4 id="how-to-access-the-header"><a class="header" href="#how-to-access-the-header">How to Access the Header</a></h4>
<p>To access the header, we can bypass <code>.Q.hg</code> and use the underlying function <code>.Q.hmb</code> directly. Here’s a quick look at the definition of <code>.Q.hg</code>:</p>
<pre><code class="language-q">q).Q.hg
k){hmb[x;`GET;()]1}
</code></pre>
<p>The function <code>.Q.hg</code> calls <code>.Q.hmb</code>, indexing the second item in the result, which is the content of the response. To access the header, we’ll need to capture the first item returned by <code>.Q.hmb</code>.</p>
<p>Let’s examine what <code>.Q.hmb</code> returns:</p>
<pre><code class="language-q">q)show res:.Q.hmb[;`GET;()] .Q.dd[baseURL;`deals]
"HTTP/1.1 200 OK\r\ndate: Tue, 03 Sep 2024 14:48:26 GMT\r\ncontent-type: application/json\r\ncont..
"[{\"internalName\":\"METAMORPHOSIS\",\"title\":\"Metamorphosis\",\"metacriticLink\":\"\\/game\\/..
</code></pre>
<p>The first item in <code>res</code> is the HTTP header, and the second item is the familiar JSON content. To extract individual elements from the header, we can split the string using <code>"\r\n"</code>:</p>
<pre><code class="language-q">q)show res:"\r\n" vs first res
"HTTP/1.1 200 OK"
"date: Tue, 03 Sep 2024 14:50:13 GMT"
"content-type: application/json"
"content-length: 8548"
"connection: close"
"cf-ray: 8bd68d08e961cca9-MAN"
"cf-cache-status: HIT"
..
</code></pre>
<h4 id="filtering-and-formatting-header-elements"><a class="header" href="#filtering-and-formatting-header-elements">Filtering and Formatting Header Elements</a></h4>
<p>To clean up the header, we remove any empty elements:</p>
<pre><code class="language-q">q)res@:where 0&lt;count each res
</code></pre>
<p>The first element in the header is the response status, which we can handle separately:</p>
<pre><code class="language-q">q)show header:enlist[`status]!enlist first res
status| "HTTP/1.1 200 OK"
</code></pre>
<p>For the remaining elements, we split them into <code>key: value</code> pairs:</p>
<pre><code class="language-q">q)x:first 1_res
q)(0,x?":") cut x
"date"
": Tue, 03 Sep 2024 14:51:39 GMT"
</code></pre>
<p>The key should be converted to a symbol and the value should have the leading <code>":"</code> removed along with any other leading whitespace:</p>
<pre><code class="language-q">q)(`$;ltrim 1_)@'(0,x?":") cut x
`date
"Tue, 03 Sep 2024 14:51:39 GMT"
</code></pre>
<p>We can apply this operation to all elements:</p>
<pre><code class="language-q">q){(`$;ltrim 1_)@'(0,x?":") cut x} each 1_res
`date            "Tue, 03 Sep 2024 14:51:39 GMT"
`content-type    "application/json"             
`content-length  "8548"                         
`connection      "close"                        
`cf-ray          "8bd68f23fef1b3e7-MAN"         
`cf-cache-status "HIT"                     
..
</code></pre>
<p>Then, convert the result into a Q dictionary:</p>
<pre><code class="language-q">q)(!). flip {(`$;ltrim 1_)@'(0,x?":") cut x} each 1_res
date           | "Tue, 03 Sep 2024 14:51:39 GMT"
content-type   | "application/json"
content-length | "8548"
connection     | "close"
cf-ray         | "8bd68f23fef1b3e7-MAN"
cf-cache-status| "HIT"
..
</code></pre>
<p>Finally, we can merge this with the header status:</p>
<pre><code class="language-q">q)show header,:(!). flip {(`$;ltrim 1_)@'(0,x?":") cut x} each 1_res
status         | "HTTP/1.1 200 OK"
date           | "Tue, 03 Sep 2024 14:51:39 GMT"
content-type   | "application/json"
content-length | "8548"
connection     | "close"
cf-ray         | "8bd68f23fef1b3e7-MAN"
cf-cache-status| "HIT"
..
</code></pre>
<h4 id="wrapping-it-up-in-a-function"><a class="header" href="#wrapping-it-up-in-a-function">Wrapping It Up in a Function</a></h4>
<p>For convenience, let’s encapsulate these steps in a function:</p>
<pre><code class="language-q">hg:{[url]
    r:.Q.hmb[url;`GET;()];
    h@:where 0&lt;count each h:"\r\n" vs first r;
    header:enlist[`status]!enlist first h;
    header,:(!). flip {(`$;ltrim 1_)@'(0,x?":") cut x} each 1_h;
    `header`content!(header;last r)
 }
</code></pre>
<h4 id="using-the-function"><a class="header" href="#using-the-function">Using the Function</a></h4>
<p>Now, we can use this function to extract the <code>x-total-page-count</code> from the header:</p>
<pre><code class="language-q">q)res:hg .Q.dd[baseURL;`deals]
q)show pageCount:"J"$res[`header]`$"x-total-page-count"
50
</code></pre>
<p>This initial query retrieves the first page of deals and the total number of pages. The content can be stored in a variable:</p>
<pre><code class="language-q">q)deals:.j.k res`content
</code></pre>
<p>For subsequent queries, we can revert to using <code>.Q.hg</code> and apply the <a href="#filtered-queries">filtered query</a> approach:</p>
<pre><code class="language-q">q)queryPage:.j.k .Q.hg .Q.dd[baseURL;] `$"deals?",buildFltStr enlist[`pageNumber]!enlist string@
q)queryPage 25 // Get 26th page (page numbering starts at 0)
internalName                             title                                             ..
-------------------------------------------------------------------------------------------..
"THETOWNOFLIGHT"                         "The Town Of Light"                               ..
"MXGP2021THEOFFICIALMOTOCROSSVIDEOGAME"  "MXGP 2021 - The Official Motocross Videogame"    ..
"KINGSBOUNTYIIDUKESEDITION"              "Kings Bounty II - Dukes Edition"                 ..
"NINOKUNIWRATHOFTHEWHITEWITCHREMASTERED" "Ni no Kuni: Wrath of the White Witch Remastered" ..
"SIDMEIERSCIVILIZATIONVIANTHOLOGY"       "Sid Meiers Civilization VI Anthology"            ..
..
</code></pre>
<p>To retrieve all pages, apply <code>queryPage</code> across the range of available pages (note that this may take some time):</p>
<pre><code class="language-q">q)pages:queryPage each 1+til pageCount
q)count pages
50
</code></pre>
<p>Finally, combine all pages into a single <code>deals</code> table by using <code>raze</code>:</p>
<pre><code class="language-q">q)deals,:raze pages
q)deals:applySchema[schema;deals]
q)deals:convertEpoch[`releaseDate;deals]
q)count deals
3060
</code></pre>
<h2 id="conclusion-1"><a class="header" href="#conclusion-1">Conclusion</a></h2>
<p>Integrating external APIs with Q/KDB+ can significantly enhance the data capabilities of your applications, particularly when dealing with large datasets or dynamic content. In this blog, we’ve explored how to interact with the <em>CheapShark</em> API, covering everything from basic API requests to more advanced topics like filtering queries, handling paginated data, and extracting valuable information from HTTP response headers.</p>
<p>By understanding these techniques, you can efficiently pull in and manipulate external data within your Q/KDB+ environment, opening up new possibilities for data analysis, application development, and real-time decision-making. Whether you’re querying for specific information or managing large datasets across multiple pages, these tools provide the flexibility needed to handle a wide range of scenarios.</p>
<p>With the knowledge from this guide, you should be well-equipped to integrate other APIs into your Q/KDB+ workflows, making your data processes even more powerful and versatile.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="the-little-q-keywords-that-could"><a class="header" href="#the-little-q-keywords-that-could">The Little Q Keywords That Could</a></h1>
<p><img src="images/little_q_keywords_that_could.png" title="Cover Image" alt="Cover Image"></p>
<p>In programming, keywords are predefined words with special meanings that form part of a language’s syntax. The Q programming language is rich with keywords, many of which were introduced to improve the readability of its predecessor, K4, by “wordifying” many primitive operations. In this blog, we’ll explore some of Q’s lesser-known or underutilised keywords that can be quite powerful when used effectively. We’ll also examine a few keywords whose usefulness might be questionable.</p>
<h2 id="csv"><a class="header" href="#csv"><code>csv</code></a></h2>
<p>The <code>csv</code> keyword is a synonym for <code>","</code>, often used to represent a comma delimiter.</p>
<p><strong>Example Usage</strong></p>
<p><code>csv</code> is primarily used when specifying a delimiter for preparing or saving text data:</p>
<pre><code class="language-q">q)csv 0: ([] a:1 2 3; b:`a`b`c)
"a,b"
"1,a"
"2,b"
"3,c"

q)"," 0: ([] a:1 2 3; b:`a`b`c)
"a,b"
"1,a"
"2,b"
"3,c"
</code></pre>
<p>In the past, <code>csv</code> was particularly useful for working with comma-separated values (CSV) files. However, other delimited file formats have become popular, and it’s now common to use different delimiters when preparing or saving text data:</p>
<pre><code class="language-q">q)"|" 0: ([] a:1 2 3; b:`a`b`c)
"a|b"
"1|a"
"2|b"
"3|c"
</code></pre>
<p>Given this shift, <code>csv</code> is less useful than it once was. To maintain consistency, especially when using different delimiters, one should prefer to specify <code>","</code> explicitly.</p>
<h2 id="dsave"><a class="header" href="#dsave"><code>dsave</code></a></h2>
<p>Introduced in version 3.2, <code>dsave</code> is a convenient keyword used to write global tables to disk as splayed, enumerated, indexed KDB+ tables. It simplifies the process of saving data, especially when dealing with partitions.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">x dsave y
</code></pre>
<ul>
<li><code>x</code> : The save path as a file symbol (atom or vector).</li>
<li><code>y</code> : One or more table names as a symbol (atom or vector).</li>
</ul>
<p><strong>Example Usage</strong></p>
<p>In a fresh Q session, let’s define simple <code>trade</code> and <code>quote</code> tables:</p>
<pre><code class="language-q">q)trade:`sym xasc flip `sym`price`qty!5?/:(`3;100f;100)
q)quote:`sym xasc flip `sym`ask`bid!10?/:(distinct trade`sym;100f;100f)
</code></pre>
<p>You can save these tables to disk using <code>dsave</code>:</p>
<pre><code class="language-q">q)`:db1 dsave `trade`quote
`trade`quote
</code></pre>
<p>The command above creates a new root directory named <em>db1</em>. Within this directory, two subdirectories, <em>trade</em> and <em>quote</em>, are created for the respective tables. Additionally, <code>dsave</code> automatically enumerates any symbol columns in the tables, resulting in the creation of a sym file under the root directory (e.g., <code>db1/sym</code>).</p>
<p><code>dsave</code> will apply the <em>parted</em> attribute to the first column of the saved tables (<code>sym</code> in this case).</p>
<pre><code class="language-q">q)\l db1 // Load db1
::

q)meta trade
c    | t f a
-----| -----
sym  | s   p
price| f    
qty  | j 

q)meta quote
c  | t f a
---| -----
sym| s   p
ask| f    
bid| f    
</code></pre>
<p>You can also save to a specific partition by providing a two-item list as the left argument. In a fresh Q session, we define the <code>trade</code> and <code>quote</code> tables as before and then save them to a partition:</p>
<pre><code class="language-q">q)`:db2`2024.01.17 dsave `trade`quote
`trade`quote
</code></pre>
<p><strong>Comparison: <code>dsave</code> vs <code>.Q.en</code> &amp; <code>.Q.dpft</code></strong></p>
<p>While similar results can be achieved using <code>set</code> combined with <code>.Q.en</code>, or <code>.Q.dpft</code>, <code>dsave</code> offers a simpler and more direct approach.</p>
<p>Using <code>set</code> and <code>.Q.en</code> (fresh Q session):</p>
<pre><code class="language-q">q)`:db3/trade/ set .Q.en[`:db3;update `p#sym from trade]
`:db3/trade/

q)`:db3/quote/ set .Q.en[`:db3;update `p#sym from quote]
`:db3/quote/
</code></pre>
<p>Using <code>.Q.dpft</code> (fresh Q session):</p>
<pre><code class="language-q">q).Q.dpft[`:db4;2024.01.17;`sym;] each `trade`quote
`trade`quote
</code></pre>
<p><code>dsave</code> streamlines this process by combining these steps into a single, more intuitive operation.</p>
<h2 id="next"><a class="header" href="#next"><code>next</code></a></h2>
<p>The <code>next</code> keyword retrieves the next item in a list, returning null for the last item since it has no successor.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">next x
</code></pre>
<ul>
<li><code>x</code> : A list from which to retrieve the next items.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)next 10 20 30
20 30 0N
</code></pre>
<p>For mixed lists, the last item is an empty list of the same type as the first item:</p>
<pre><code class="language-q">q)next (10 20 30f;"hello";`blah)
"hello"
`blah
`float$()
</code></pre>
<p><code>next</code> is particularly useful when dealing with temporal types:</p>
<pre><code class="language-q">q)quote:([] sym:6#`a`b; time:00:01:00.000+"j"$1e3*0 0 17 42 68 112)

q)update next[time]-time by sym from quote // Duration of a quote
sym time
----------------
a   00:00:17.000
b   00:00:42.000
a   00:00:51.000
b   00:01:10.000
a
b
</code></pre>
<p><strong>Implementation</strong></p>
<p>Conceptually, <code>next</code> performs the following operation:</p>
<pre><code class="language-q">1_x,enlist x 0N
</code></pre>
<h2 id="prev"><a class="header" href="#prev"><code>prev</code></a></h2>
<p>The <code>prev</code> keyword retrieves the previous item in a list, returning null for the first item since it has no predecessor.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">prev x
</code></pre>
<ul>
<li><code>x</code> : A list from which to retrieve the previous items.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)prev 10 20 30
0N 10 20
</code></pre>
<p>For mixed lists, the first item is an empty list of the same type as the first item in the original list:</p>
<pre><code class="language-q">q)prev (10 20 30f;"hello";`blah)
`float$()
10 20 30f
"hello"
</code></pre>
<p><strong>Implementation</strong></p>
<p><code>prev</code> is effectively doing this:</p>
<pre><code class="language-q">(enlist x 0N),-1_x
</code></pre>
<h2 id="xprev"><a class="header" href="#xprev"><code>xprev</code></a></h2>
<p>The <code>xprev</code> keyword allows you to access the item <em>x</em> places before the current item in a list, padding with nulls where necessary.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">x xprev y
</code></pre>
<ul>
<li><code>x</code> : The number of positions to look back.</li>
<li><code>y</code> : The list from which to retrieve the previous items.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)2 xprev 10 20 30 40 50
0N 0N 10 20 30
</code></pre>
<p>For mixed lists, the first <em>x</em> items are empty lists of the same type as the first item in the original list:</p>
<pre><code class="language-q">q)2 xprev (10 20 30f;"hello";`blah;1 2 3f;101b)
`float$()
`float$()
10 20 30f
"hello"
`blah
</code></pre>
<p><strong>Implementation</strong></p>
<p>Conceptually, <code>xprev</code> performs the following:</p>
<pre><code class="language-q">y (til count y)-x
</code></pre>
<h2 id="rand"><a class="header" href="#rand"><code>rand</code></a></h2>
<p>The <code>rand</code> keyword is used to pick or generate a random value.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">rand x
</code></pre>
<ul>
<li><code>x</code> : A list (to select a random element) or a number (to generate a random number between 0 and <em>x</em>).</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)rand 10 20 30 40 50
50
q)rand 1000
360
</code></pre>
<p><code>rand</code> is a shorthand for the following:</p>
<pre><code class="language-q">first 1?x
</code></pre>
<p>While <code>rand</code> is convenient for generating a single random item, the <code>?</code> operator should be preferred for generating larger sets:</p>
<pre><code class="language-q">q)\ts rand each 1000000#10
626 41164880
q)\ts 1000000?10
19 8388800
</code></pre>
<h2 id="reciprocal"><a class="header" href="#reciprocal"><code>reciprocal</code></a></h2>
<p>The <code>reciprocal</code> keyword computes the reciprocal of a number or a list of numbers.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">reciprocal x
</code></pre>
<ul>
<li><code>x</code> : A number or a list of numbers for which to compute the reciprocal.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)reciprocal 1 2 3 4 5
1 0.5 0.3333333 0.25 0.2
</code></pre>
<p>This operation is equivalent to applying the <code>%</code> operator with 1 as its left operand:</p>
<pre><code class="language-q">q)1%1 2 3 4 5
1 0.5 0.3333333 0.25 0.2
</code></pre>
<p>Both forms have similar performance:</p>
<pre><code class="language-q">q)\ts:100 reciprocal 1+til 10000000
4127 402660944

q)\ts:100 1%1+til 10000000
4070 402660384
</code></pre>
<p>While <code>reciprocal</code> is more verbose, <code>%</code> is often preferred for its succinctness and clarity.</p>
<h2 id="rload--rsave"><a class="header" href="#rload--rsave"><code>rload</code> &amp; <code>rsave</code></a></h2>
<p>The <code>rload</code> and <code>rsave</code> keywords are used to load and save splayed tables from and to directories, respectively.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">rload x
</code></pre>
<ul>
<li><code>x</code> : The directory path (as a symbol) from which to load a splayed table.</li>
</ul>
<pre><code class="language-q">rsave x
</code></pre>
<ul>
<li><code>x</code> : The directory path (as a symbol) to which a global table will be saved.</li>
</ul>
<p><strong>Example Usage</strong></p>
<p>In a fresh Q session, define and save a splayed <code>trade</code> table:</p>
<pre><code class="language-q">q)trade:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100)

q)rsave `:db/trade
`:db/trade/
</code></pre>
<p>The <code>trade</code> table can be loaded using <code>rload</code>:</p>
<pre><code class="language-q">q)delete trade from `. // remove from memory
`.

q)rload `:db/trade
`trade
</code></pre>
<p><strong>Comparison: <code>rload</code> &amp; <code>rsave</code> vs <code>get</code> &amp; <code>set</code></strong></p>
<p><code>rload</code> and <code>rsave</code> are less flexible than the <code>get</code> and <code>set</code> keywords, which allow specifying different target directory names.</p>
<p>For example, saving with a different name using <code>set</code> and loading using <code>get</code>:</p>
<pre><code class="language-q">q)`:db/tradeOther/ set trade
`:db/tradeOther/

q)delete tradeOther from `.
`.

q)tradeOther:get `:db/tradeOther/
</code></pre>
<p><code>rload</code> and <code>rsave</code> also require global tables, whereas <code>get</code> and <code>set</code> can work with local tables.</p>
<pre><code class="language-q">q)f:{[] tradeLocal:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100); rsave `:db/tradeLocal}

q)f[]
'tradeLocal
  [1]  f:{[] tradeLocal:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100); rsave `:db/tradeLocal}
                                                                                    ^
</code></pre>
<pre><code class="language-q">q)f:{[] tradeLocal:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100); `:db/tradeLocal/ set tradeLocal}

q)f[]
`:db/tradeLocal/
</code></pre>
<p>Implicit iteration is a benefit of <code>rload</code> and <code>rsave</code>:</p>
<pre><code class="language-q">q)t1:([] a:1 2 3; b:"abc")

q)t2:([] a:4 5 6; b:"def")

q)rsave `t1`t2
`:t1/`:t2/

q)delete t1, t2 from `.

q)rload `t1`t2
</code></pre>
<p>Explicit iteration is required with <code>get</code> and <code>set</code>:</p>
<pre><code class="language-q">q)`:t1/`:t2/ set' (t1;t2)
`:t1/`:t2/

q)get each `:t1`:t2
+`a`b!(1 2 3;"abc")
+`a`b!(4 5 6;"def")
</code></pre>
<p>If you don’t need the extra flexibility of <code>get</code> and <code>set</code>, <code>rload</code> and <code>rsave</code> offer a simpler method for saving and loading splayed tables.</p>
<h2 id="signum"><a class="header" href="#signum"><code>signum</code></a></h2>
<p>The <code>signum</code> keyword evaluates an integer value and returns:</p>
<ul>
<li><code>-1i</code> for a null or negative value</li>
<li><code>0i</code> for a zero value</li>
<li><code>1i</code> for a positive value</li>
</ul>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">signum x
</code></pre>
<ul>
<li><code>x</code> : An integer value.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)signum -1 0 1 0N
-1 0 1 -1i
</code></pre>
<p>You can use <code>signum</code> to categorise and count price movements by their direction:</p>
<pre><code class="language-q">q)t:([] price:10 11 9 8 8 15)

q)select ct:count i by direction:signum deltas price from t
direction| ct
---------| --
-1       | 2
0        | 1
1        | 3
</code></pre>
<p>This example demonstrates how <code>signum</code> can be used to summarise directional price changes in a dataset.</p>
<h2 id="sublist"><a class="header" href="#sublist"><code>sublist</code></a></h2>
<p>The <code>sublist</code> keyword selects a subset of a list.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">x sublist y
</code></pre>
<ul>
<li><code>x</code> : The number of items to take from the start of the list if positive, or from the end if negative.</li>
<li><code>y</code> : The list from which to extract the sublist.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)3 sublist 10 20 30 40 50
10 20 30

q)-3 sublist 10 20 30 40 50
30 40 50
</code></pre>
<p>If the requested sublist exceeds the available items, it returns as many items as possible:</p>
<pre><code class="language-q">q)10 sublist 10 20 30 40 50
10 20 30 40 50
</code></pre>
<p>You can also select a slice of the list:</p>
<pre><code class="language-q">q)1 3 sublist 10 20 30 40 50
20 30 40

q)1 10 sublist 10 20 30 40 50
20 30 40 50
</code></pre>
<p><strong>Comparison: <code>sublist</code> vs take (<code>#</code>)</strong></p>
<p>Use <code>sublist</code> when you want to avoid exceeding the number of available items, unlike the <code>#</code> operator which always returns the requested number of items:</p>
<pre><code class="language-q">q)10#"Hey"
"HeyHeyHeyH"

q)10 sublist "Hey"
"Hey"
</code></pre>
<h2 id="conclusion-2"><a class="header" href="#conclusion-2">Conclusion</a></h2>
<p>In the Q programming language, while some keywords are well-known and frequently used, there are others that, though lesser-known, offer powerful functionality that can simplify and optimise your code. From efficient data-saving methods with <code>dsave</code>, to navigating lists with <code>next</code>, <code>prev</code>, and <code>xprev</code>, and managing splayed tables with <code>rload</code> and <code>rsave</code>, these keywords may seem minor at first glance, but they can make a significant difference in your code’s clarity and maintainability.</p>
<p>However, not all keywords are equally valuable in every context. For instance, the <code>csv</code> keyword, a shorthand for comma-delimited text, might be less useful in modern coding practices where other delimiters are also prevalent. Similarly, while <code>reciprocal</code> provides a way to calculate the reciprocal of a number, the more concise <code>1%</code> is usually preferred for its brevity and clarity.</p>
<p>Understanding and utilising these underappreciated keywords not only enhances your proficiency in Q but also opens up new possibilities for writing more readable, efficient, and maintainable code. So, the next time you’re coding in Q, consider reaching for these keywords – they might just become your new favourites.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="analysis-of-q-memory-allocation"><a class="header" href="#analysis-of-q-memory-allocation">Analysis of Q Memory Allocation</a></h1>
<p><img src="images/analysis_of_q_memory_allocation.png" title="Cover Image" alt="Cover Image"></p>
<p>Memory allocation is a crucial aspect of any programming language, affecting performance and resource management. This blog delves into how the Q programming language handles memory allocation using the buddy memory allocation system.</p>
<h2 id="buddy-memory-allocation-in-q"><a class="header" href="#buddy-memory-allocation-in-q">Buddy Memory Allocation in Q</a></h2>
<p>Q uses a form of <a href="https://en.wikipedia.org/wiki/Buddy_memory_allocation">buddy memory allocation</a> for its memory management. Memory is requested in chunks whose sizes are powers of two, regardless of the actual memory required by an object.</p>
<p>For instance, if an object needs 1,000 bytes, a block of 1,024 bytes (\(2^{10}\)) will be allocated. If the object grows to need 1,025 bytes, the allocated block size will increase to 2,048 bytes (\(2^{11}\)). This system allows efficient memory usage by minimising the frequency of allocations as objects grow.</p>
<h2 id="list-memory-usage"><a class="header" href="#list-memory-usage">List Memory Usage</a></h2>
<p>A long integer in Q is an 8-byte value. Thus, a list of <em>N</em> long integers requires \(8 \times N\) bytes of memory. We can use the <code>-22!</code> command to check the uncompressed length (in bytes) of a list.</p>
<p><strong>Example</strong></p>
<p>Creating a list of 10,000,000 long integers and viewing its memory usage:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)-22!mylist 
80000014
</code></pre>
<p>The list requires 80,000,014 bytes. The extra 14 bytes store metadata about the list, such as type, count, reference count, and attributes. This overhead is consistent across lists in Q.</p>
<pre><code class="language-q">// A list of 2 longs : (2 * 8) + 14 = 30
q)-22!til 2
30

// A list of 5 chars : (5 * 1) + 14 = 19
q)-22!"hello"
19
</code></pre>
<h2 id="heap-allocation"><a class="header" href="#heap-allocation">Heap Allocation</a></h2>
<h3 id="initial-memory-usage"><a class="header" href="#initial-memory-usage">Initial Memory Usage</a></h3>
<p>In a fresh Q session, we can check the initial used and heap memory:</p>
<pre><code class="language-q">q)show before:`used`heap#.Q.w[]
used| 362736
heap| 67108864
</code></pre>
<ul>
<li>
<p><strong>Used Memory</strong>: Total memory currently used by all defined objects in the Q process, including internal structures.</p>
</li>
<li>
<p><strong>Heap Memory</strong>: Total system memory allocated to the Q process, initially 64 MB (\(2^{26}\) bytes).</p>
</li>
</ul>
<h3 id="dynamic-memory-allocation"><a class="header" href="#dynamic-memory-allocation">Dynamic Memory Allocation</a></h3>
<p>As memory demands increase, the heap size will adjust accordingly. For instance, creating a list of 10,000,000 longs:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)show after:`used`heap#.Q.w[]
used| 134580608
heap| 201326592
</code></pre>
<p>The heap size increased to accommodate the list. The heap size formula in Q is:</p>
<p>\[
2^{26} + 2^{n} \times x
\]</p>
<p>where \(n \ge 26\) and <em>x</em> is 0 or 1 depending on whether the initial memory is sufficient or not.</p>
<h3 id="example-calculation"><a class="header" href="#example-calculation">Example Calculation</a></h3>
<p>Creating a list of 10,000,000 longs requires 80,000,014 bytes. Initially, the heap size is 64 MB. After creating the list, the heap increases to 192 MB, i.e., \(2^{26} + 2^{27}\) bytes.</p>
<h2 id="used-allocation"><a class="header" href="#used-allocation">Used Allocation</a></h2>
<p>Used memory represents the actual memory required by objects, while allocated blocks follow the buddy system.</p>
<p><strong>Example</strong></p>
<p>Comparing memory before and after list creation:</p>
<pre><code class="language-q">q)after-before
used| 134217872
heap| 134217728
</code></pre>
<p>The increase in used memory by 134,217,872 bytes indicates the buddy system’s allocation, where the block size must be a power of two, plus some overhead and memory to store the <code>before</code> dictionary (\(134,217,872 = 134,217,728 + 144\), where the 144 bytes is the overhead to store the <code>before</code> dictionary).</p>
<h2 id="object-reserved-memory"><a class="header" href="#object-reserved-memory">Object Reserved Memory</a></h2>
<p>Q reserves memory blocks as powers of two for objects, allowing efficient growth without frequent reallocations.</p>
<p><strong>Example</strong></p>
<p>Appending 1,000,000 longs to a list of 10,000,000 longs:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)show before:`used`heap#.Q.w[]
used| 134580512
heap| 201326592

q)mylist,:til 1000000

q)show after:`used`heap#.Q.w[]
used| 134580608
heap| 201326592

q)after-before
used| 96
heap| 0
</code></pre>
<p>The used memory barely changes, as the additional longs fit into the reserved memory of the list.</p>
<h3 id="new-list-allocation"><a class="header" href="#new-list-allocation">New List Allocation</a></h3>
<p>If we create a new list, Q must allocate a different memory block for it, causing a significant increase in used memory:</p>
<pre><code class="language-q">q)newlist:til 1000000

q)show afterNewList:`used`heap#.Q.w[];
used| 142968208
heap| 201326592

q)afterNewList-after
used| 8387600
heap| 0
</code></pre>
<p>The creation of <code>newlist</code> increases the used memory by 8,387,600 bytes, reflecting the allocation of a new memory block.</p>
<h2 id="releasing-reserved-memory"><a class="header" href="#releasing-reserved-memory">Releasing Reserved Memory</a></h2>
<p>Clearing data from an object releases its memory back to the heap.</p>
<p><strong>Example</strong></p>
<p>Clearing a list:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)show before:`used`heap#.Q.w[]
used| 134579200
heap| 201326592

q)mylist:0#mylist

q)show after:`used`heap#.Q.w[]
used| 361584
heap| 201326592

q)after-before
used| -134217616
heap| 0
</code></pre>
<p>The used memory returns to its initial state.</p>
<h2 id="garbage-collection"><a class="header" href="#garbage-collection">Garbage Collection</a></h2>
<p>Q’s default garbage collection mode is deferred, meaning it triggers in two cases:</p>
<ul>
<li><code>.Q.gc[]</code> is called manually.</li>
<li>Memory limit is hit (set with <code>-w</code> on the command line).</li>
</ul>
<p>It is important to think about how certain operations in Q work behind the scenes when it comes to memory.</p>
<p>When we join items to a list using the join operator (<code>,</code>) Q will copy data from one list to the other. Therefore, at some stage, we will have two copies of the list, requiring double the memory of the original list to perform the operation.</p>
<p><strong>Example</strong></p>
<p>In a fresh Q session, we create an empty list of longs, then join 10,000,000 longs:</p>
<pre><code class="language-q">q)mylist:"j"$()

q)show before:`used`heap#.Q.w[]
used| 362800
heap| 67108864

q)\ts mylist,:til 10000000
28 268435680

q)show after:`used`heap#.Q.w[]
used| 134580608
heap| 335544320
</code></pre>
<p>Previously, a heap size of 201,326,592 bytes was enough to accommodate our list of 10,000,000 longs. However, at one point in the join operation we will have two copies of 10,000,000 longs (20,000,000 longs in total). Therefore, we require more memory. Using the <code>\ts</code> command confirms this by showing us that the join operation used 268,435,680 bytes of memory to perform.</p>
<p>After this operation, the heap is unnecessarily big, consuming system resources that we do not need. We can release this unused memory back to the OS by invoking <code>.Q.gc[]</code>:</p>
<pre><code class="language-q">q).Q.gc[] // Manual garbage collection
134217728

q)show afterGC:`used`heap#.Q.w[]
used| 134579456
heap| 201326592
</code></pre>
<p>The heap size reduces after garbage collection, freeing up system resources.</p>
<h2 id="conclusion-3"><a class="header" href="#conclusion-3">Conclusion</a></h2>
<p>Understanding memory allocation in Q, particularly through the buddy memory allocation system, provides insight into efficient memory management and helps in optimising performance. The examples illustrate how Q handles memory for lists, the impact of heap allocation, and the benefits of manual garbage collection. Moreover, it is essential to consider how operations like joining lists impact memory usage, potentially doubling the memory required during the operation and necessitating periodic garbage collection to free up resources.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-2c2089fd.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/navigation-8d154390.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>


    </div>
    </body>
</html>
