<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Q/KDB Blog</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-ced79429.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-3135433e.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Q/KDB Blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="the-little-q-keywords-that-could"><a class="header" href="#the-little-q-keywords-that-could">The Little Q Keywords That Could</a></h1>
<p><img src="images/little_q_keywords_that_could.png" title="The Little Q Keywords That Could Cover Image" alt="The Little Q Keywords That Could Cover Image"></p>
<p>In programming, keywords are predefined words with special meanings that form part of a language’s syntax. The Q programming language is rich with keywords, many of which were introduced to improve the readability of its predecessor, K4, by “wordifying” many primitive operations. In this blog, we’ll explore some of Q’s lesser-known or underutilised keywords that can be quite powerful when used effectively. We’ll also examine a few keywords whose usefulness might be questionable.</p>
<h2 id="csv"><a class="header" href="#csv"><code>csv</code></a></h2>
<p>The <code>csv</code> keyword is a synonym for <code>","</code>, often used to represent a comma delimiter.</p>
<p><strong>Example Usage</strong></p>
<p><code>csv</code> is primarily used when specifying a delimiter for preparing or saving text data:</p>
<pre><code class="language-q">q)csv 0: ([] a:1 2 3; b:`a`b`c)
"a,b"
"1,a"
"2,b"
"3,c"

q)"," 0: ([] a:1 2 3; b:`a`b`c)
"a,b"
"1,a"
"2,b"
"3,c"
</code></pre>
<p>In the past, <code>csv</code> was particularly useful for working with comma-separated values (CSV) files. However, other delimited file formats have become popular, and it’s now common to use different delimiters when preparing or saving text data:</p>
<pre><code class="language-q">q)"|" 0: ([] a:1 2 3; b:`a`b`c)
"a|b"
"1|a"
"2|b"
"3|c"
</code></pre>
<p>Given this shift, <code>csv</code> is less useful than it once was. To maintain consistency, especially when using different delimiters, one should prefer to specify <code>","</code> explicitly.</p>
<h2 id="dsave"><a class="header" href="#dsave"><code>dsave</code></a></h2>
<p>Introduced in version 3.2, <code>dsave</code> is a convenient keyword used to write global tables to disk as splayed, enumerated, indexed KDB+ tables. It simplifies the process of saving data, especially when dealing with partitions.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">x dsave y
</code></pre>
<ul>
<li><code>x</code> : The save path as a file symbol (atom or vector).</li>
<li><code>y</code> : One or more table names as a symbol (atom or vector).</li>
</ul>
<p><strong>Example Usage</strong></p>
<p>In a fresh Q session, let’s define simple <code>trade</code> and <code>quote</code> tables:</p>
<pre><code class="language-q">q)trade:`sym xasc flip `sym`price`qty!5?/:(`3;100f;100)
q)quote:`sym xasc flip `sym`ask`bid!10?/:(distinct trade`sym;100f;100f)
</code></pre>
<p>You can save these tables to disk using <code>dsave</code>:</p>
<pre><code class="language-q">q)`:db1 dsave `trade`quote
`trade`quote
</code></pre>
<p>The command above creates a new root directory named <em>db1</em>. Within this directory, two subdirectories, <em>trade</em> and <em>quote</em>, are created for the respective tables. Additionally, <code>dsave</code> automatically enumerates any symbol columns in the tables, resulting in the creation of a sym file under the root directory (e.g., <code>db1/sym</code>).</p>
<p><code>dsave</code> will apply the <em>parted</em> attribute to the first column of the saved tables (<code>sym</code> in this case).</p>
<pre><code class="language-q">q)\l db1 // Load db1
::

q)meta trade
c    | t f a
-----| -----
sym  | s   p
price| f    
qty  | j 

q)meta quote
c  | t f a
---| -----
sym| s   p
ask| f    
bid| f    
</code></pre>
<p>You can also save to a specific partition by providing a two-item list as the left argument. In a fresh Q session, we define the <code>trade</code> and <code>quote</code> tables as before and then save them to a partition:</p>
<pre><code class="language-q">q)`:db2`2024.01.17 dsave `trade`quote
`trade`quote
</code></pre>
<p><strong>Comparison: <code>dsave</code> vs <code>.Q.en</code> &amp; <code>.Q.dpft</code></strong></p>
<p>While similar results can be achieved using <code>set</code> combined with <code>.Q.en</code>, or <code>.Q.dpft</code>, <code>dsave</code> offers a simpler and more direct approach.</p>
<p>Using <code>set</code> and <code>.Q.en</code> (fresh Q session):</p>
<pre><code class="language-q">q)`:db3/trade/ set .Q.en[`:db3;update `p#sym from trade]
`:db3/trade/

q)`:db3/quote/ set .Q.en[`:db3;update `p#sym from quote]
`:db3/quote/
</code></pre>
<p>Using <code>.Q.dpft</code> (fresh Q session):</p>
<pre><code class="language-q">q).Q.dpft[`:db4;2024.01.17;`sym;] each `trade`quote
`trade`quote
</code></pre>
<p><code>dsave</code> streamlines this process by combining these steps into a single, more intuitive operation.</p>
<h2 id="next"><a class="header" href="#next"><code>next</code></a></h2>
<p>The <code>next</code> keyword retrieves the next item in a list, returning null for the last item since it has no successor.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">next x
</code></pre>
<ul>
<li><code>x</code> : A list from which to retrieve the next items.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)next 10 20 30
20 30 0N
</code></pre>
<p>For mixed lists, the last item is an empty list of the same type as the first item:</p>
<pre><code class="language-q">q)next (10 20 30f;"hello";`blah)
"hello"
`blah
`float$()
</code></pre>
<p><code>next</code> is particularly useful when dealing with temporal types:</p>
<pre><code class="language-q">q)quote:([] sym:6#`a`b; time:00:01:00.000+"j"$1e3*0 0 17 42 68 112)

q)update next[time]-time by sym from quote // Duration of a quote
sym time
----------------
a   00:00:17.000
b   00:00:42.000
a   00:00:51.000
b   00:01:10.000
a
b
</code></pre>
<p><strong>Implementation</strong></p>
<p>Conceptually, <code>next</code> performs the following operation:</p>
<pre><code class="language-q">1_x,enlist x 0N
</code></pre>
<h2 id="prev"><a class="header" href="#prev"><code>prev</code></a></h2>
<p>The <code>prev</code> keyword retrieves the previous item in a list, returning null for the first item since it has no predecessor.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">prev x
</code></pre>
<ul>
<li><code>x</code> : A list from which to retrieve the previous items.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)prev 10 20 30
0N 10 20
</code></pre>
<p>For mixed lists, the first item is an empty list of the same type as the first item in the original list:</p>
<pre><code class="language-q">q)prev (10 20 30f;"hello";`blah)
`float$()
10 20 30f
"hello"
</code></pre>
<p><strong>Implementation</strong></p>
<p><code>prev</code> is effectively doing this:</p>
<pre><code class="language-q">(enlist x 0N),-1_x
</code></pre>
<h2 id="xprev"><a class="header" href="#xprev"><code>xprev</code></a></h2>
<p>The <code>xprev</code> keyword allows you to access the item <em>x</em> places before the current item in a list, padding with nulls where necessary.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">x xprev y
</code></pre>
<ul>
<li><code>x</code> : The number of positions to look back.</li>
<li><code>y</code> : The list from which to retrieve the previous items.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)2 xprev 10 20 30 40 50
0N 0N 10 20 30
</code></pre>
<p>For mixed lists, the first <em>x</em> items are empty lists of the same type as the first item in the original list:</p>
<pre><code class="language-q">q)2 xprev (10 20 30f;"hello";`blah;1 2 3f;101b)
`float$()
`float$()
10 20 30f
"hello"
`blah
</code></pre>
<p><strong>Implementation</strong></p>
<p>Conceptually, <code>xprev</code> performs the following:</p>
<pre><code class="language-q">y (til count y)-x
</code></pre>
<h2 id="rand"><a class="header" href="#rand"><code>rand</code></a></h2>
<p>The <code>rand</code> keyword is used to pick or generate a random value.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">rand x
</code></pre>
<ul>
<li><code>x</code> : A list (to select a random element) or a number (to generate a random number between 0 and <em>x</em>).</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)rand 10 20 30 40 50
50
q)rand 1000
360
</code></pre>
<p><code>rand</code> is a shorthand for the following:</p>
<pre><code class="language-q">first 1?x
</code></pre>
<p>While <code>rand</code> is convenient for generating a single random item, the <code>?</code> operator should be preferred for generating larger sets:</p>
<pre><code class="language-q">q)\ts rand each 1000000#10
626 41164880
q)\ts 1000000?10
19 8388800
</code></pre>
<h2 id="reciprocal"><a class="header" href="#reciprocal"><code>reciprocal</code></a></h2>
<p>The <code>reciprocal</code> keyword computes the reciprocal of a number or a list of numbers.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">reciprocal x
</code></pre>
<ul>
<li><code>x</code> : A number or a list of numbers for which to compute the reciprocal.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)reciprocal 1 2 3 4 5
1 0.5 0.3333333 0.25 0.2
</code></pre>
<p>This operation is equivalent to applying the <code>%</code> operator with 1 as its left operand:</p>
<pre><code class="language-q">q)1%1 2 3 4 5
1 0.5 0.3333333 0.25 0.2
</code></pre>
<p>Both forms have similar performance:</p>
<pre><code class="language-q">q)\ts:100 reciprocal 1+til 10000000
4127 402660944

q)\ts:100 1%1+til 10000000
4070 402660384
</code></pre>
<p>While <code>reciprocal</code> is more verbose, <code>%</code> is often preferred for its succinctness and clarity.</p>
<h2 id="rload--rsave"><a class="header" href="#rload--rsave"><code>rload</code> &amp; <code>rsave</code></a></h2>
<p>The <code>rload</code> and <code>rsave</code> keywords are used to load and save splayed tables from and to directories, respectively.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">rload x
</code></pre>
<ul>
<li><code>x</code> : The directory path (as a symbol) from which to load a splayed table.</li>
</ul>
<pre><code class="language-q">rsave x
</code></pre>
<ul>
<li><code>x</code> : The directory path (as a symbol) to which a global table will be saved.</li>
</ul>
<p><strong>Example Usage</strong></p>
<p>In a fresh Q session, define and save a splayed <code>trade</code> table:</p>
<pre><code class="language-q">q)trade:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100)

q)rsave `:db/trade
`:db/trade/
</code></pre>
<p>The <code>trade</code> table can be loaded using <code>rload</code>:</p>
<pre><code class="language-q">q)delete trade from `. // remove from memory
`.

q)rload `:db/trade
`trade
</code></pre>
<p><strong>Comparison: <code>rload</code> &amp; <code>rsave</code> vs <code>get</code> &amp; <code>set</code></strong></p>
<p><code>rload</code> and <code>rsave</code> are less flexible than the <code>get</code> and <code>set</code> keywords, which allow specifying different target directory names.</p>
<p>For example, saving with a different name using <code>set</code> and loading using <code>get</code>:</p>
<pre><code class="language-q">q)`:db/tradeOther/ set trade
`:db/tradeOther/

q)delete tradeOther from `.
`.

q)tradeOther:get `:db/tradeOther/
</code></pre>
<p><code>rload</code> and <code>rsave</code> also require global tables, whereas <code>get</code> and <code>set</code> can work with local tables.</p>
<pre><code class="language-q">q)f:{[] tradeLocal:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100); rsave `:db/tradeLocal}

q)f[]
'tradeLocal
  [1]  f:{[] tradeLocal:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100); rsave `:db/tradeLocal}
                                                                                    ^
</code></pre>
<pre><code class="language-q">q)f:{[] tradeLocal:update `sym?sym from flip `sym`price`qty!5?/:(`3;100f;100); `:db/tradeLocal/ set tradeLocal}

q)f[]
`:db/tradeLocal/
</code></pre>
<p>Implicit iteration is a benefit of <code>rload</code> and <code>rsave</code>:</p>
<pre><code class="language-q">q)t1:([] a:1 2 3; b:"abc")

q)t2:([] a:4 5 6; b:"def")

q)rsave `t1`t2
`:t1/`:t2/

q)delete t1, t2 from `.

q)rload `t1`t2
</code></pre>
<p>Explicit iteration is required with <code>get</code> and <code>set</code>:</p>
<pre><code class="language-q">q)`:t1/`:t2/ set' (t1;t2)
`:t1/`:t2/

q)get each `:t1`:t2
+`a`b!(1 2 3;"abc")
+`a`b!(4 5 6;"def")
</code></pre>
<p>If you don’t need the extra flexibility of <code>get</code> and <code>set</code>, <code>rload</code> and <code>rsave</code> offer a simpler method for saving and loading splayed tables.</p>
<h2 id="signum"><a class="header" href="#signum"><code>signum</code></a></h2>
<p>The <code>signum</code> keyword evaluates an integer value and returns:</p>
<ul>
<li><code>-1i</code> for a null or negative value</li>
<li><code>0i</code> for a zero value</li>
<li><code>1i</code> for a positive value</li>
</ul>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">signum x
</code></pre>
<ul>
<li><code>x</code> : An integer value.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)signum -1 0 1 0N
-1 0 1 -1i
</code></pre>
<p>You can use <code>signum</code> to categorise and count price movements by their direction:</p>
<pre><code class="language-q">q)t:([] price:10 11 9 8 8 15)

q)select ct:count i by direction:signum deltas price from t
direction| ct
---------| --
-1       | 2
0        | 1
1        | 3
</code></pre>
<p>This example demonstrates how <code>signum</code> can be used to summarise directional price changes in a dataset.</p>
<h2 id="sublist"><a class="header" href="#sublist"><code>sublist</code></a></h2>
<p>The <code>sublist</code> keyword selects a subset of a list.</p>
<p><strong>Syntax</strong></p>
<pre><code class="language-q">x sublist y
</code></pre>
<ul>
<li><code>x</code> : The number of items to take from the start of the list if positive, or from the end if negative.</li>
<li><code>y</code> : The list from which to extract the sublist.</li>
</ul>
<p><strong>Example Usage</strong></p>
<pre><code class="language-q">q)3 sublist 10 20 30 40 50
10 20 30

q)-3 sublist 10 20 30 40 50
30 40 50
</code></pre>
<p>If the requested sublist exceeds the available items, it returns as many items as possible:</p>
<pre><code class="language-q">q)10 sublist 10 20 30 40 50
10 20 30 40 50
</code></pre>
<p>You can also select a slice of the list:</p>
<pre><code class="language-q">q)1 3 sublist 10 20 30 40 50
20 30 40

q)1 10 sublist 10 20 30 40 50
20 30 40 50
</code></pre>
<p><strong>Comparison: <code>sublist</code> vs take (<code>#</code>)</strong></p>
<p>Use <code>sublist</code> when you want to avoid exceeding the number of available items, unlike the <code>#</code> operator which always returns the requested number of items:</p>
<pre><code class="language-q">q)10#"Hey"
"HeyHeyHeyH"

q)10 sublist "Hey"
"Hey"
</code></pre>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>In the Q programming language, while some keywords are well-known and frequently used, there are others that, though lesser-known, offer powerful functionality that can simplify and optimise your code. From efficient data-saving methods with <code>dsave</code>, to navigating lists with <code>next</code>, <code>prev</code>, and <code>xprev</code>, and managing splayed tables with <code>rload</code> and <code>rsave</code>, these keywords may seem minor at first glance, but they can make a significant difference in your code’s clarity and maintainability.</p>
<p>However, not all keywords are equally valuable in every context. For instance, the <code>csv</code> keyword, a shorthand for comma-delimited text, might be less useful in modern coding practices where other delimiters are also prevalent. Similarly, while <code>reciprocal</code> provides a way to calculate the reciprocal of a number, the more concise <code>1%</code> is usually preferred for its brevity and clarity.</p>
<p>Understanding and utilising these underappreciated keywords not only enhances your proficiency in Q but also opens up new possibilities for writing more readable, efficient, and maintainable code. So, the next time you’re coding in Q, consider reaching for these keywords – they might just become your new favourites.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="analysis-of-q-memory-allocation"><a class="header" href="#analysis-of-q-memory-allocation">Analysis of Q Memory Allocation</a></h1>
<p><img src="images/analysis_of_q_memory_allocation.png" title="Analysis of Q Memory Allocation Cover Image" alt="Analysis of Q Memory Allocation Cover Image"></p>
<p>Memory allocation is a crucial aspect of any programming language, affecting performance and resource management. This blog delves into how the Q programming language handles memory allocation using the buddy memory allocation system.</p>
<h2 id="buddy-memory-allocation-in-q"><a class="header" href="#buddy-memory-allocation-in-q">Buddy Memory Allocation in Q</a></h2>
<p>Q uses a form of <a href="https://en.wikipedia.org/wiki/Buddy_memory_allocation">buddy memory allocation</a> for its memory management. Memory is requested in chunks whose sizes are powers of two, regardless of the actual memory required by an object.</p>
<p>For instance, if an object needs 1,000 bytes, a block of 1,024 bytes (\(2^{10}\)) will be allocated. If the object grows to need 1,025 bytes, the allocated block size will increase to 2,048 bytes (\(2^{11}\)). This system allows efficient memory usage by minimising the frequency of allocations as objects grow.</p>
<h2 id="list-memory-usage"><a class="header" href="#list-memory-usage">List Memory Usage</a></h2>
<p>A long integer in Q is an 8-byte value. Thus, a list of <em>N</em> long integers requires \(8 \times N\) bytes of memory. We can use the <code>-22!</code> command to check the uncompressed length (in bytes) of a list.</p>
<p><strong>Example</strong></p>
<p>Creating a list of 10,000,000 long integers and viewing its memory usage:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)-22!mylist 
80000014
</code></pre>
<p>The list requires 80,000,014 bytes. The extra 14 bytes store metadata about the list, such as type, count, reference count, and attributes. This overhead is consistent across lists in Q.</p>
<pre><code class="language-q">// A list of 2 longs : (2 * 8) + 14 = 30
q)-22!til 2
30

// A list of 5 chars : (5 * 1) + 14 = 19
q)-22!"hello"
19
</code></pre>
<h2 id="heap-allocation"><a class="header" href="#heap-allocation">Heap Allocation</a></h2>
<h3 id="initial-memory-usage"><a class="header" href="#initial-memory-usage">Initial Memory Usage</a></h3>
<p>In a fresh Q session, we can check the initial used and heap memory:</p>
<pre><code class="language-q">q)show before:`used`heap#.Q.w[]
used| 362736
heap| 67108864
</code></pre>
<ul>
<li>
<p><strong>Used Memory</strong>: Total memory currently used by all defined objects in the Q process, including internal structures.</p>
</li>
<li>
<p><strong>Heap Memory</strong>: Total system memory allocated to the Q process, initially 64 MB (\(2^{26}\) bytes).</p>
</li>
</ul>
<h3 id="dynamic-memory-allocation"><a class="header" href="#dynamic-memory-allocation">Dynamic Memory Allocation</a></h3>
<p>As memory demands increase, the heap size will adjust accordingly. For instance, creating a list of 10,000,000 longs:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)show after:`used`heap#.Q.w[]
used| 134580608
heap| 201326592
</code></pre>
<p>The heap size increased to accommodate the list. The heap size formula in Q is:</p>
<p>\[
2^{26} + 2^{n} \times x
\]</p>
<p>where \(n \ge 26\) and <em>x</em> is 0 or 1 depending on whether the initial memory is sufficient or not.</p>
<h3 id="example-calculation"><a class="header" href="#example-calculation">Example Calculation</a></h3>
<p>Creating a list of 10,000,000 longs requires 80,000,014 bytes. Initially, the heap size is 64 MB. After creating the list, the heap increases to 192 MB, i.e., \(2^{26} + 2^{27}\) bytes.</p>
<h2 id="used-allocation"><a class="header" href="#used-allocation">Used Allocation</a></h2>
<p>Used memory represents the actual memory required by objects, while allocated blocks follow the buddy system.</p>
<p><strong>Example</strong></p>
<p>Comparing memory before and after list creation:</p>
<pre><code class="language-q">q)after-before
used| 134217872
heap| 134217728
</code></pre>
<p>The increase in used memory by 134,217,872 bytes indicates the buddy system’s allocation, where the block size must be a power of two, plus some overhead and memory to store the <code>before</code> dictionary (\(134,217,872 = 134,217,728 + 144\), where the 144 bytes is the overhead to store the <code>before</code> dictionary).</p>
<h2 id="object-reserved-memory"><a class="header" href="#object-reserved-memory">Object Reserved Memory</a></h2>
<p>Q reserves memory blocks as powers of two for objects, allowing efficient growth without frequent reallocations.</p>
<p><strong>Example</strong></p>
<p>Appending 1,000,000 longs to a list of 10,000,000 longs:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)show before:`used`heap#.Q.w[]
used| 134580512
heap| 201326592

q)mylist,:til 1000000

q)show after:`used`heap#.Q.w[]
used| 134580608
heap| 201326592

q)after-before
used| 96
heap| 0
</code></pre>
<p>The used memory barely changes, as the additional longs fit into the reserved memory of the list.</p>
<h3 id="new-list-allocation"><a class="header" href="#new-list-allocation">New List Allocation</a></h3>
<p>If we create a new list, Q must allocate a different memory block for it, causing a significant increase in used memory:</p>
<pre><code class="language-q">q)newlist:til 1000000

q)show afterNewList:`used`heap#.Q.w[];
used| 142968208
heap| 201326592

q)afterNewList-after
used| 8387600
heap| 0
</code></pre>
<p>The creation of <code>newlist</code> increases the used memory by 8,387,600 bytes, reflecting the allocation of a new memory block.</p>
<h2 id="releasing-reserved-memory"><a class="header" href="#releasing-reserved-memory">Releasing Reserved Memory</a></h2>
<p>Clearing data from an object releases its memory back to the heap.</p>
<p><strong>Example</strong></p>
<p>Clearing a list:</p>
<pre><code class="language-q">q)mylist:til 10000000

q)show before:`used`heap#.Q.w[]
used| 134579200
heap| 201326592

q)mylist:0#mylist

q)show after:`used`heap#.Q.w[]
used| 361584
heap| 201326592

q)after-before
used| -134217616
heap| 0
</code></pre>
<p>The used memory returns to its initial state.</p>
<h2 id="garbage-collection"><a class="header" href="#garbage-collection">Garbage Collection</a></h2>
<p>Q’s default garbage collection mode is deferred, meaning it triggers in two cases:</p>
<ul>
<li><code>.Q.gc[]</code> is called manually.</li>
<li>Memory limit is hit (set with <code>-w</code> on the command line).</li>
</ul>
<p>It is important to think about how certain operations in Q work behind the scenes when it comes to memory.</p>
<p>When we join items to a list using the join operator (<code>,</code>) Q will copy data from one list to the other. Therefore, at some stage, we will have two copies of the list, requiring double the memory of the original list to perform the operation.</p>
<p><strong>Example</strong></p>
<p>In a fresh Q session, we create an empty list of longs, then join 10,000,000 longs:</p>
<pre><code class="language-q">q)mylist:"j"$()

q)show before:`used`heap#.Q.w[]
used| 362800
heap| 67108864

q)\ts mylist,:til 10000000
28 268435680

q)show after:`used`heap#.Q.w[]
used| 134580608
heap| 335544320
</code></pre>
<p>Previously, a heap size of 201,326,592 bytes was enough to accommodate our list of 10,000,000 longs. However, at one point in the join operation we will have two copies of 10,000,000 longs (20,000,000 longs in total). Therefore, we require more memory. Using the <code>\ts</code> command confirms this by showing us that the join operation used 268,435,680 bytes of memory to perform.</p>
<p>After this operation, the heap is unnecessarily big, consuming system resources that we do not need. We can release this unused memory back to the OS by invoking <code>.Q.gc[]</code>:</p>
<pre><code class="language-q">q).Q.gc[] // Manual garbage collection
134217728

q)show afterGC:`used`heap#.Q.w[]
used| 134579456
heap| 201326592
</code></pre>
<p>The heap size reduces after garbage collection, freeing up system resources.</p>
<h2 id="conclusion-1"><a class="header" href="#conclusion-1">Conclusion</a></h2>
<p>Understanding memory allocation in Q, particularly through the buddy memory allocation system, provides insight into efficient memory management and helps in optimising performance. The examples illustrate how Q handles memory for lists, the impact of heap allocation, and the benefits of manual garbage collection. Moreover, it is essential to consider how operations like joining lists impact memory usage, potentially doubling the memory required during the operation and necessitating periodic garbage collection to free up resources.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-80932283.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>


    </div>
    </body>
</html>
